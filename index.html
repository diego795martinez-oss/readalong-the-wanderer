<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Read-Along (EFL) — Web Speech API</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="min-h-screen bg-slate-50 text-slate-900">
  <div class="mx-auto max-w-4xl px-4 py-6 sm:py-10">
    <!-- Header -->
    <header class="mb-6 sm:mb-8">
      <div class="flex flex-col gap-2 sm:flex-row sm:items-end sm:justify-between">
        <div>
          <h1 id="title" class="text-2xl sm:text-3xl font-bold tracking-tight">
            THE WANDERER <span class="text-slate-500 font-semibold">by Sharon Creech</span>
          </h1>
          <p id="context" class="mt-2 text-sm sm:text-base italic text-slate-600">
            The main character, Sophie, is an orphan adopted by uncles. She is sailing across the Atlantic with her cousins.
          </p>
        </div>

        <div class="flex items-center gap-2">
          <span class="inline-flex items-center gap-2 rounded-full bg-white px-3 py-1 text-xs sm:text-sm shadow-sm ring-1 ring-slate-200">
            <span class="h-2.5 w-2.5 rounded-full" id="statusDot" style="background:#94a3b8"></span>
            <span id="statusText" class="text-slate-700">Paused</span>
          </span>
        </div>
      </div>
    </header>

    <!-- Unsupported Browser Warning -->
    <div id="unsupported" class="hidden mb-6 rounded-xl border border-amber-200 bg-amber-50 p-4 text-amber-900">
      <p class="font-semibold">Browser not supported.</p>
      <p class="mt-1 text-sm">
        Please use Google Chrome or Microsoft Edge (desktop or Android). Some iOS versions and Firefox may not support the Web Speech API.
      </p>
    </div>

    <!-- Main Card -->
    <main class="rounded-2xl bg-white shadow-sm ring-1 ring-slate-200">
      <div class="p-4 sm:p-6">

        <!-- Tabs -->
        <div class="mb-4 flex items-center gap-2">
          <button id="tabRead"
            class="flex-1 sm:flex-none inline-flex items-center justify-center rounded-xl px-4 py-3 text-base font-semibold shadow-sm ring-1 ring-slate-200 focus:outline-none focus:ring-4 focus:ring-slate-200">
            Read Along
          </button>
          <button id="tabReport"
            class="flex-1 sm:flex-none inline-flex items-center justify-center rounded-xl px-4 py-3 text-base font-semibold shadow-sm ring-1 ring-slate-200 focus:outline-none focus:ring-4 focus:ring-slate-200">
            Report
          </button>
        </div>

        <!-- READ TAB -->
        <div id="readTab" class="flex flex-col gap-3 sm:gap-4">

          <div class="flex flex-col gap-3 sm:flex-row sm:items-end sm:justify-between">
            <div class="grid grid-cols-2 gap-2 sm:flex sm:gap-3">
              <button id="micBtn"
                class="col-span-2 sm:col-auto inline-flex items-center justify-center rounded-xl bg-slate-900 px-4 py-3 text-base font-semibold text-white shadow-sm hover:bg-slate-800 active:scale-[0.99] focus:outline-none focus:ring-4 focus:ring-slate-200">
                Start Reading
              </button>

              <button id="prevBtn"
                class="inline-flex items-center justify-center rounded-xl bg-white px-4 py-3 text-base font-semibold text-slate-900 shadow-sm ring-1 ring-slate-200 hover:bg-slate-50 active:scale-[0.99] focus:outline-none focus:ring-4 focus:ring-slate-200">
                Previous
              </button>

              <button id="nextBtn"
                class="inline-flex items-center justify-center rounded-xl bg-white px-4 py-3 text-base font-semibold text-slate-900 shadow-sm ring-1 ring-slate-200 hover:bg-slate-50 active:scale-[0.99] focus:outline-none focus:ring-4 focus:ring-slate-200">
                Next
              </button>

              <button id="restartBtn"
                class="col-span-2 sm:col-auto inline-flex items-center justify-center rounded-xl bg-white px-4 py-3 text-base font-semibold text-slate-900 shadow-sm ring-1 ring-slate-200 hover:bg-slate-50 active:scale-[0.99] focus:outline-none focus:ring-4 focus:ring-slate-200">
                Restart Paragraph
              </button>
            </div>

            <div class="flex flex-col gap-2 sm:items-end">
              <label class="text-sm font-medium text-slate-700" for="langSelect">Recognition Accent</label>
              <select id="langSelect"
                class="w-full sm:w-56 rounded-xl border border-slate-200 bg-white px-3 py-3 text-base shadow-sm focus:outline-none focus:ring-4 focus:ring-slate-200">
                <option value="en-US" selected>English (US) — en-US</option>
                <option value="en-GB">English (UK) — en-GB</option>
              </select>
            </div>
          </div>

          <!-- Paragraph Area -->
          <section aria-label="Reading paragraph" class="rounded-2xl bg-slate-50 p-4 sm:p-6 ring-1 ring-slate-200">
            <div class="flex items-center justify-between gap-3">
              <p class="text-xs sm:text-sm font-semibold text-slate-600">
                Paragraph <span id="paraIdx">1</span> / <span id="paraTotal">5</span>
              </p>
              <p class="text-xs sm:text-sm text-slate-500" id="hint">
                Tip: Words turn green as the engine recognizes them (current paragraph only).
              </p>
            </div>

            <div class="mt-4 text-lg sm:text-xl leading-relaxed text-slate-900" id="paragraphDisplay"></div>

            <div class="mt-5">
              <div class="flex items-center justify-between">
                <p class="text-xs sm:text-sm font-semibold text-slate-700">Live transcript (what the computer hears)</p>
                <button id="clearTranscript" class="text-xs sm:text-sm font-semibold text-slate-700 hover:text-slate-900">
                  Clear
                </button>
              </div>

              <div class="mt-2 rounded-xl bg-white p-3 sm:p-4 text-sm sm:text-base text-slate-700 shadow-sm ring-1 ring-slate-200" id="transcriptBox">
                <span class="text-slate-400">(interim results will appear here)</span>
              </div>
            </div>
          </section>

          <!-- Teacher Mode -->
          <section class="rounded-2xl bg-white p-4 sm:p-6 ring-1 ring-slate-200">
            <div class="flex items-center justify-between gap-3">
              <div>
                <h2 class="text-lg font-bold">Teacher Mode</h2>
                <p class="text-sm text-slate-600">Paste new text and split it by new lines to create a new paragraph flow.</p>
              </div>
              <label class="inline-flex items-center gap-2 rounded-xl bg-slate-50 px-3 py-2 text-sm font-semibold text-slate-700 ring-1 ring-slate-200 select-none">
                <input id="teacherToggle" type="checkbox" class="h-5 w-5 rounded border-slate-300 text-slate-900 focus:ring-slate-200" />
                Edit
              </label>
            </div>

            <div id="teacherPanel" class="hidden mt-4">
              <div class="grid gap-3">
                <textarea id="teacherText"
                  class="min-h-[160px] w-full rounded-xl border border-slate-200 bg-white p-3 text-sm sm:text-base shadow-sm focus:outline-none focus:ring-4 focus:ring-slate-200"
                  placeholder="Paste text here.

Tip: If you include lines starting with 'Title:' and 'Context:', they will update the header."></textarea>

                <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
                  <p class="text-xs sm:text-sm text-slate-600">Rules: non-empty lines become paragraphs. Recognition + report reset on update.</p>
                  <div class="flex gap-2">
                    <button id="loadDefault"
                      class="flex-1 sm:flex-none inline-flex items-center justify-center rounded-xl bg-white px-4 py-3 text-base font-semibold text-slate-900 shadow-sm ring-1 ring-slate-200 hover:bg-slate-50 active:scale-[0.99] focus:outline-none focus:ring-4 focus:ring-slate-200">
                      Load Default
                    </button>
                    <button id="applyTeacher"
                      class="flex-1 sm:flex-none inline-flex items-center justify-center rounded-xl bg-slate-900 px-4 py-3 text-base font-semibold text-white shadow-sm hover:bg-slate-800 active:scale-[0.99] focus:outline-none focus:ring-4 focus:ring-slate-200">
                      Apply Text
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </section>

          <footer class="pt-1 pb-2">
            <p class="text-xs text-slate-500">
              Privacy: Audio is processed locally by your browser using the Web Speech API. Nothing is stored or uploaded by this page.
            </p>
          </footer>
        </div>

        <!-- REPORT TAB -->
        <div id="reportTabPanel" class="hidden">
          <section class="rounded-2xl bg-slate-50 p-4 sm:p-6 ring-1 ring-slate-200">
            <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
              <div>
                <h2 class="text-lg sm:text-xl font-bold">Reading Report</h2>
                <p class="text-sm text-slate-600">
                  Shows words read correctly (green) vs not yet read correctly (red), based on your best progress per paragraph.
                </p>
              </div>
              <div class="flex gap-2">
                <button id="refreshReport"
                  class="flex-1 sm:flex-none inline-flex items-center justify-center rounded-xl bg-white px-4 py-3 text-base font-semibold text-slate-900 shadow-sm ring-1 ring-slate-200 hover:bg-slate-50 active:scale-[0.99] focus:outline-none focus:ring-4 focus:ring-slate-200">
                  Refresh
                </button>
                <button id="clearReport"
                  class="flex-1 sm:flex-none inline-flex items-center justify-center rounded-xl bg-slate-900 px-4 py-3 text-base font-semibold text-white shadow-sm hover:bg-slate-800 active:scale-[0.99] focus:outline-none focus:ring-4 focus:ring-slate-200">
                  Clear Report
                </button>
              </div>
            </div>

            <div class="mt-4 grid gap-3 sm:grid-cols-3">
              <div class="rounded-2xl bg-white p-4 shadow-sm ring-1 ring-slate-200">
                <p class="text-xs font-semibold text-slate-600">Total words</p>
                <p id="statTotalWords" class="mt-1 text-2xl font-bold">0</p>
              </div>
              <div class="rounded-2xl bg-white p-4 shadow-sm ring-1 ring-slate-200">
                <p class="text-xs font-semibold text-slate-600">Correct words</p>
                <p id="statCorrectWords" class="mt-1 text-2xl font-bold">0</p>
              </div>
              <div class="rounded-2xl bg-white p-4 shadow-sm ring-1 ring-slate-200">
                <p class="text-xs font-semibold text-slate-600">Accuracy</p>
                <p id="statAccuracy" class="mt-1 text-2xl font-bold">0%</p>
              </div>
            </div>

            <div class="mt-5 grid gap-4" id="reportList"></div>

            <p class="mt-4 text-xs text-slate-500">
              Note: Matching is tolerant and sequential (it expects the paragraph in order). If a student skips a word, the report may count later words as “not yet correct” even if they were said out of order.
            </p>
          </section>
        </div>

      </div>
    </main>
  </div>

<script>
(() => {
  // ---------------------------
  // Default Content
  // ---------------------------
  const DEFAULT = {
    title: 'THE WANDERER',
    author: 'Sharon Creech',
    context: 'The main character, Sophie, is an orphan adopted by uncles. She is sailing across the Atlantic with her cousins.',
    paragraphs: [
      "I am not always such a dreamy girl, listening to the sea calling me. My father calls me Three-sided Sophie: one side is dreamy and romantic; one is logical and down-to-earth; and the third side is hardheaded and impulsive. He says I am either in dreamland or earthland or mule-land, and if I ever get the three together, I'll be all set, though I wonder where I will be then. If I'm not in dreamland or earthland or mule-land, where will I be?",
      "My father says my logical side is most like him, and the dreamy side most like my mother, which isn't entirely fair, I don't think. My father likes to think of himself as a logical man, but he is the one who pores over pictures of exotic lands and says things like \"We should go on a safari!\" and \"We should zip through the air in a hot-air balloon!\"",
      "And although my mother is a weaver and spins silky cloths and wears flowing dresses, she is the one who gives me sailing textbooks and makes me study water safety and weather prediction and says things like \"Yes, Sophie, I taught you to sail, but that doesn't mean I like the idea of you being out there alone on the water. I want you to stay home. Here. With me. Safe.\"",
      "My father says he doesn't know who my hardheaded mule side resembles. He says mules don't run in the family. I am thirteen, and I am going to sail across the ocean. Although I would like to go alone-alone! alone! flying over the water!-I'm not.",
      "My mule-self begged a place aboard a forty-five-foot sailboat with a motley crew: three uncles and two cousins. The uncles-Stew, Mo, and Dock-are my mother's brothers, and she told them, \"If the slightest harm comes to my Sophie, I'll string you all up by your toes.\""
    ]
  };

  // ---------------------------
  // DOM
  // ---------------------------
  const $ = (id) => document.getElementById(id);

  const titleEl = $('title');
  const contextEl = $('context');
  const paragraphDisplay = $('paragraphDisplay');
  const transcriptBox = $('transcriptBox');

  const micBtn = $('micBtn');
  const prevBtn = $('prevBtn');
  const nextBtn = $('nextBtn');
  const restartBtn = $('restartBtn');
  const clearTranscriptBtn = $('clearTranscript');
  const langSelect = $('langSelect');

  const statusText = $('statusText');
  const statusDot = $('statusDot');
  const unsupported = $('unsupported');

  const paraIdxEl = $('paraIdx');
  const paraTotalEl = $('paraTotal');

  const teacherToggle = $('teacherToggle');
  const teacherPanel = $('teacherPanel');
  const teacherText = $('teacherText');
  const applyTeacher = $('applyTeacher');
  const loadDefault = $('loadDefault');

  // Tabs + report
  const tabReadBtn = $('tabRead');
  const tabReportBtn = $('tabReport');
  const readTab = $('readTab');
  const reportTabPanel = $('reportTabPanel');
  const refreshReportBtn = $('refreshReport');
  const clearReportBtn = $('clearReport');
  const reportList = $('reportList');
  const statTotalWords = $('statTotalWords');
  const statCorrectWords = $('statCorrectWords');
  const statAccuracy = $('statAccuracy');

  // ---------------------------
  // Web Speech Support
  // ---------------------------
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  const isSupported = !!SpeechRecognition;

  if (!isSupported) {
    unsupported.classList.remove('hidden');
    [
      micBtn, prevBtn, nextBtn, restartBtn, langSelect, clearTranscriptBtn,
      teacherToggle, tabReadBtn, tabReportBtn, refreshReportBtn, clearReportBtn
    ].forEach(el => {
      el.disabled = true;
      el.classList.add('opacity-50', 'cursor-not-allowed');
    });
  }

  // ---------------------------
  // State
  // ---------------------------
  let content = structuredClone(DEFAULT);
  let paragraphIndex = 0;
  let listening = false;

  // Current paragraph tokens for highlighting
  let spanWords = []; // [{ original, norm, el }]

  // Transcripts
  let finalTranscript = '';
  let interimTranscript = '';
  let finalMatchedCount = 0;
  let combinedMatchedCount = 0;

  // Report tracking per paragraph (best progress)
  // bestFinalCount is used for "correct vs not" in the report.
  let progress = []; // [{ bestFinalCount, bestCombinedCount }]

  // Token cache for report display (original words per paragraph)
  let paragraphTokens = []; // [ [{original,norm}] ...]

  let recognition = null;

  // ---------------------------
  // Helpers
  // ---------------------------
  const normalizeWord = (w) => (w || '')
    .toLowerCase()
    .replace(/['’]/g, '')
    .replace(/[^a-z0-9]+/g, '')
    .trim();

  const tokenize = (text) => (text || '')
    .replace(/\s+/g, ' ')
    .trim()
    .split(' ')
    .map(normalizeWord)
    .filter(Boolean);

  // Greedy tolerant matcher (in-order; ignores extra tokens)
  const computeMatchedCount = (heardTokens, targetTokens) => {
    let i = 0;
    for (const t of heardTokens) {
      if (i >= targetTokens.length) break;
      if (!t) continue;
      if (t === targetTokens[i]) i++;
    }
    return i;
  };

  const setStatus = (label, dotColor) => {
    statusText.textContent = label;
    statusDot.style.background = dotColor;
  };

  const setTranscript = (finalText, interimText) => {
    const f = (finalText || '').trim();
    const it = (interimText || '').trim();

    if (!f && !it) {
      transcriptBox.innerHTML = '<span class="text-slate-400">(interim results will appear here)</span>';
      return;
    }

    transcriptBox.innerHTML = '';
    if (f) {
      const fSpan = document.createElement('span');
      fSpan.textContent = f;
      transcriptBox.appendChild(fSpan);
    }
    if (it) {
      if (f) transcriptBox.appendChild(document.createTextNode(' '));
      const iSpan = document.createElement('span');
      iSpan.textContent = it;
      iSpan.className = 'italic text-slate-500';
      transcriptBox.appendChild(iSpan);
    }
  };

  const clearRecognitionBufferUI = () => {
    finalTranscript = '';
    interimTranscript = '';
    finalMatchedCount = 0;
    combinedMatchedCount = 0;
    setTranscript('', '');
    renderHighlights();
  };

  const rebuildParagraphTokensAndProgress = () => {
    paragraphTokens = content.paragraphs.map(p => {
      const raw = (p || '').replace(/\s+/g, ' ').trim().split(' ').filter(Boolean);
      return raw.map(tok => ({ original: tok, norm: normalizeWord(tok) })).filter(t => t.norm);
    });
    progress = content.paragraphs.map(() => ({ bestFinalCount: 0, bestCombinedCount: 0 }));
  };

  // ---------------------------
  // Tabs
  // ---------------------------
  const setActiveTab = (tab) => {
    const isRead = tab === 'read';
    readTab.classList.toggle('hidden', !isRead);
    reportTabPanel.classList.toggle('hidden', isRead);

    // Button styles
    const active = 'bg-slate-900 text-white ring-slate-900';
    const inactive = 'bg-white text-slate-900 ring-slate-200 hover:bg-slate-50';

    tabReadBtn.className = `flex-1 sm:flex-none inline-flex items-center justify-center rounded-xl px-4 py-3 text-base font-semibold shadow-sm ring-1 focus:outline-none focus:ring-4 focus:ring-slate-200 ${isRead ? active : inactive}`;
    tabReportBtn.className = `flex-1 sm:flex-none inline-flex items-center justify-center rounded-xl px-4 py-3 text-base font-semibold shadow-sm ring-1 focus:outline-none focus:ring-4 focus:ring-slate-200 ${!isRead ? active : inactive}`;

    if (!isRead) renderReport();
  };

  // ---------------------------
  // Rendering
  // ---------------------------
  const escapeHtml = (s) => (s || '').replace(/[&<>"']/g, (c) => ({
    '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
  }[c]));

  const renderHeader = () => {
    titleEl.innerHTML = `${escapeHtml(content.title)} <span class="text-slate-500 font-semibold">by ${escapeHtml(content.author || '')}</span>`;
    contextEl.textContent = content.context || '';
  };

  const renderParagraph = () => {
    const paragraph = content.paragraphs[paragraphIndex] || '';
    const rawTokens = paragraph.replace(/\s+/g, ' ').trim().split(' ').filter(Boolean);

    spanWords = rawTokens.map((tok) => {
      const span = document.createElement('span');
      span.textContent = tok;
      span.className = 'transition-colors duration-200';
      return { original: tok, norm: normalizeWord(tok), el: span };
    });

    paragraphDisplay.innerHTML = '';
    spanWords.forEach((w, idx) => {
      paragraphDisplay.appendChild(w.el);
      if (idx < spanWords.length - 1) paragraphDisplay.appendChild(document.createTextNode(' '));
    });

    paraIdxEl.textContent = String(paragraphIndex + 1);
    paraTotalEl.textContent = String(content.paragraphs.length);

    clearRecognitionBufferUI();

    prevBtn.disabled = paragraphIndex === 0;
    nextBtn.disabled = paragraphIndex === content.paragraphs.length - 1;
    [prevBtn, nextBtn].forEach(btn => {
      btn.classList.toggle('opacity-50', btn.disabled);
      btn.classList.toggle('cursor-not-allowed', btn.disabled);
    });
  };

  const renderHighlights = () => {
    // Colors:
    // - Final-confirmed words: strong green
    // - Interim-only words: lighter green
    // - Next expected word: underline amber

    const targetTokens = spanWords.map(w => w.norm).filter(Boolean);
    const finalCount = Math.min(finalMatchedCount, targetTokens.length);
    const combinedCount = Math.min(combinedMatchedCount, targetTokens.length);

    let normalizedIndex = 0;

    for (const w of spanWords) {
      if (!w.norm) {
        w.el.className = 'transition-colors duration-200 text-slate-900';
        continue;
      }

      const idx = normalizedIndex;

      if (idx < finalCount) {
        w.el.className = 'transition-colors duration-200 font-semibold text-emerald-700';
      } else if (idx < combinedCount) {
        w.el.className = 'transition-colors duration-200 font-semibold text-emerald-500';
      } else if (idx === combinedCount) {
        w.el.className = 'transition-colors duration-200 text-slate-900 underline decoration-amber-400 decoration-4 underline-offset-4';
      } else {
        w.el.className = 'transition-colors duration-200 text-slate-900';
      }

      normalizedIndex++;
    }
  };

  // ---------------------------
  // Report Rendering
  // ---------------------------
  const renderReport = () => {
    // Totals
    const totalWords = paragraphTokens.reduce((sum, arr) => sum + arr.length, 0);
    const correctWords = paragraphTokens.reduce((sum, arr, i) => sum + Math.min(progress[i]?.bestFinalCount || 0, arr.length), 0);
    const accuracy = totalWords === 0 ? 0 : Math.round((correctWords / totalWords) * 100);

    statTotalWords.textContent = String(totalWords);
    statCorrectWords.textContent = String(correctWords);
    statAccuracy.textContent = `${accuracy}%`;

    reportList.innerHTML = '';

    content.paragraphs.forEach((p, i) => {
      const tokens = paragraphTokens[i] || [];
      const best = Math.min(progress[i]?.bestFinalCount || 0, tokens.length);
      const pct = tokens.length ? Math.round((best / tokens.length) * 100) : 0;

      const card = document.createElement('div');
      card.className = 'rounded-2xl bg-white p-4 sm:p-5 shadow-sm ring-1 ring-slate-200';

      const header = document.createElement('div');
      header.className = 'flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between';

      const left = document.createElement('div');
      left.innerHTML = `
        <p class="text-xs font-semibold text-slate-600">Paragraph ${i + 1}</p>
        <p class="mt-1 text-sm text-slate-700">${best} / ${tokens.length} words correct</p>
      `;

      const right = document.createElement('div');
      right.className = 'inline-flex items-center gap-2 rounded-full bg-slate-50 px-3 py-1 text-xs font-semibold text-slate-700 ring-1 ring-slate-200';
      right.textContent = `${pct}%`;

      header.appendChild(left);
      header.appendChild(right);

      const correctWrap = document.createElement('div');
      correctWrap.className = 'mt-4';
      correctWrap.innerHTML = `<p class="text-xs font-semibold text-slate-600">Correct</p>`;

      const correctChips = document.createElement('div');
      correctChips.className = 'mt-2 flex flex-wrap gap-2';

      const incorrectWrap = document.createElement('div');
      incorrectWrap.className = 'mt-4';
      incorrectWrap.innerHTML = `<p class="text-xs font-semibold text-slate-600">Not yet correct</p>`;

      const incorrectChips = document.createElement('div');
      incorrectChips.className = 'mt-2 flex flex-wrap gap-2';

      const correctTokens = tokens.slice(0, best);
      const incorrectTokens = tokens.slice(best);

      if (correctTokens.length === 0) {
        const empty = document.createElement('span');
        empty.className = 'text-sm text-slate-400';
        empty.textContent = '(none yet)';
        correctChips.appendChild(empty);
      } else {
        correctTokens.forEach(t => {
          const chip = document.createElement('span');
          chip.className = 'rounded-full bg-emerald-50 px-3 py-1 text-sm font-semibold text-emerald-700 ring-1 ring-emerald-200';
          chip.textContent = t.original;
          correctChips.appendChild(chip);
        });
      }

      if (incorrectTokens.length === 0) {
        const empty = document.createElement('span');
        empty.className = 'text-sm text-slate-400';
        empty.textContent = '(all words correct!)';
        incorrectChips.appendChild(empty);
      } else {
        incorrectTokens.forEach(t => {
          const chip = document.createElement('span');
          chip.className = 'rounded-full bg-rose-50 px-3 py-1 text-sm font-semibold text-rose-700 ring-1 ring-rose-200';
          chip.textContent = t.original;
          incorrectChips.appendChild(chip);
        });
      }

      correctWrap.appendChild(correctChips);
      incorrectWrap.appendChild(incorrectChips);

      // Quick actions
      const actions = document.createElement('div');
      actions.className = 'mt-4 flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between';

      const jump = document.createElement('button');
      jump.className = 'inline-flex items-center justify-center rounded-xl bg-white px-4 py-3 text-base font-semibold text-slate-900 shadow-sm ring-1 ring-slate-200 hover:bg-slate-50 active:scale-[0.99] focus:outline-none focus:ring-4 focus:ring-slate-200';
      jump.textContent = 'Go to this paragraph';
      jump.addEventListener('click', () => {
        setActiveTab('read');
        goToParagraph(i);
      });

      const resetThis = document.createElement('button');
      resetThis.className = 'inline-flex items-center justify-center rounded-xl bg-white px-4 py-3 text-base font-semibold text-slate-900 shadow-sm ring-1 ring-slate-200 hover:bg-slate-50 active:scale-[0.99] focus:outline-none focus:ring-4 focus:ring-slate-200';
      resetThis.textContent = 'Reset this paragraph result';
      resetThis.addEventListener('click', () => {
        progress[i].bestFinalCount = 0;
        progress[i].bestCombinedCount = 0;
        renderReport();
      });

      actions.appendChild(jump);
      actions.appendChild(resetThis);

      card.appendChild(header);
      card.appendChild(correctWrap);
      card.appendChild(incorrectWrap);
      card.appendChild(actions);

      reportList.appendChild(card);
    });
  };

  // ---------------------------
  // Recognition lifecycle
  // ---------------------------
  const initRecognition = () => {
    if (!isSupported) return;

    recognition = new SpeechRecognition();
    recognition.lang = langSelect.value || 'en-US';
    recognition.continuous = true;
    recognition.interimResults = true;
    recognition.maxAlternatives = 1;

    recognition.onstart = () => {
      listening = true;
      micBtn.textContent = 'Stop';
      setStatus('Listening...', '#10b981');
    };

    recognition.onend = () => {
      listening = false;
      micBtn.textContent = 'Start Reading';
      setStatus('Paused', '#94a3b8');
    };

    recognition.onerror = (e) => {
      if (e.error === 'not-allowed' || e.error === 'service-not-allowed') {
        setStatus('Microphone access denied', '#ef4444');
      } else if (e.error === 'no-speech') {
        setStatus('No speech detected', '#f59e0b');
      } else {
        setStatus(`Error: ${e.error}`, '#ef4444');
      }
    };

    recognition.onresult = (event) => {
      let newFinal = '';
      let newInterim = '';

      for (let i = 0; i < event.results.length; i++) {
        const res = event.results[i];
        const text = res[0].transcript;
        if (res.isFinal) newFinal += text + ' ';
        else newInterim += text + ' ';
      }

      finalTranscript = (newFinal || '').replace(/\s+/g, ' ').trim();
      interimTranscript = (newInterim || '').replace(/\s+/g, ' ').trim();

      setTranscript(finalTranscript, interimTranscript);

      // Match ONLY against current paragraph.
      const targetTokens = spanWords.map(w => w.norm).filter(Boolean);
      finalMatchedCount = computeMatchedCount(tokenize(finalTranscript), targetTokens);
      combinedMatchedCount = computeMatchedCount(tokenize((finalTranscript + ' ' + interimTranscript).trim()), targetTokens);

      // Update best progress for report
      const tLen = paragraphTokens[paragraphIndex]?.length || targetTokens.length;
      const cur = progress[paragraphIndex];
      if (cur) {
        cur.bestFinalCount = Math.min(Math.max(cur.bestFinalCount, finalMatchedCount), tLen);
        cur.bestCombinedCount = Math.min(Math.max(cur.bestCombinedCount, combinedMatchedCount), tLen);
      }

      renderHighlights();

      // If report tab is open, keep it live-updated
      if (!reportTabPanel.classList.contains('hidden')) {
        renderReport();
      }
    };
  };

  const startListening = () => {
    if (!isSupported) return;
    if (!recognition) initRecognition();
    try { recognition.start(); } catch (_) {}
  };

  const stopListening = () => {
    if (!isSupported || !recognition) return;
    try { recognition.stop(); } catch (_) {}
  };

  const hardResetRecognition = (keepListening) => {
    if (!isSupported) return;
    const shouldResume = !!keepListening;

    try { recognition && recognition.abort(); } catch (_) {}

    recognition = null;
    initRecognition();

    clearRecognitionBufferUI();

    if (shouldResume) {
      setTimeout(() => startListening(), 120);
    }
  };

  // ---------------------------
  // Navigation
  // ---------------------------
  const goToParagraph = (idx) => {
    const clamped = Math.max(0, Math.min(idx, content.paragraphs.length - 1));
    if (clamped === paragraphIndex) return;

    const wasListening = listening;
    if (wasListening) stopListening();

    paragraphIndex = clamped;
    renderParagraph();

    hardResetRecognition(wasListening);
  };

  const restartParagraph = () => {
    const wasListening = listening;
    if (wasListening) stopListening();

    clearRecognitionBufferUI();
    hardResetRecognition(wasListening);
  };

  // ---------------------------
  // Teacher Mode Parsing
  // ---------------------------
  const applyTeacherText = () => {
    const raw = (teacherText.value || '').replace(/\r\n/g, '\n');
    const lines = raw.split('\n').map(l => l.trim());

    let newTitle = content.title;
    let newAuthor = content.author;
    let newContext = content.context;

    const paragraphs = [];
    for (const line of lines) {
      if (!line) continue;

      if (/^title\s*:/i.test(line)) {
        const t = line.replace(/^title\s*:/i, '').trim();
        const byMatch = t.match(/^(.*)\s+by\s+(.*)$/i);
        if (byMatch) {
          newTitle = byMatch[1].trim() || newTitle;
          newAuthor = byMatch[2].trim() || newAuthor;
        } else {
          newTitle = t || newTitle;
        }
        continue;
      }

      if (/^author\s*:/i.test(line)) {
        newAuthor = line.replace(/^author\s*:/i, '').trim() || newAuthor;
        continue;
      }

      if (/^context\s*:/i.test(line)) {
        newContext = line.replace(/^context\s*:/i, '').trim() || newContext;
        continue;
      }

      paragraphs.push(line);
    }

    if (paragraphs.length === 0) {
      setStatus('Teacher text had no paragraphs', '#f59e0b');
      return;
    }

    if (listening) stopListening();

    content = { title: newTitle, author: newAuthor, context: newContext, paragraphs };
    paragraphIndex = 0;

    // Reset report + tokens
    rebuildParagraphTokensAndProgress();

    renderHeader();
    renderParagraph();
    renderReport();

    hardResetRecognition(false);
    setStatus('Paused', '#94a3b8');
  };

  const loadDefaultText = () => {
    teacherText.value = `Title: ${DEFAULT.title} by ${DEFAULT.author}\nContext: ${DEFAULT.context}\n\n${DEFAULT.paragraphs.join('\n\n')}`;
  };

  // ---------------------------
  // Events
  // ---------------------------
  micBtn.addEventListener('click', () => {
    if (!isSupported) return;
    if (!recognition) initRecognition();

    if (!listening) {
      hardResetRecognition(false);
      startListening();
    } else {
      stopListening();
    }
  });

  prevBtn.addEventListener('click', () => goToParagraph(paragraphIndex - 1));
  nextBtn.addEventListener('click', () => goToParagraph(paragraphIndex + 1));
  restartBtn.addEventListener('click', restartParagraph);

  clearTranscriptBtn.addEventListener('click', () => {
    const wasListening = listening;
    if (wasListening) stopListening();
    clearRecognitionBufferUI();
    hardResetRecognition(wasListening);
  });

  langSelect.addEventListener('change', () => {
    const wasListening = listening;
    if (wasListening) stopListening();
    hardResetRecognition(wasListening);
  });

  teacherToggle.addEventListener('change', (e) => {
    teacherPanel.classList.toggle('hidden', !e.target.checked);
    if (e.target.checked && !teacherText.value.trim()) loadDefaultText();
  });

  applyTeacher.addEventListener('click', applyTeacherText);
  loadDefault.addEventListener('click', () => {
    loadDefaultText();
    setStatus('Paused', '#94a3b8');
  });

  // Tabs
  tabReadBtn.addEventListener('click', () => setActiveTab('read'));
  tabReportBtn.addEventListener('click', () => setActiveTab('report'));

  refreshReportBtn.addEventListener('click', renderReport);
  clearReportBtn.addEventListener('click', () => {
    progress = content.paragraphs.map(() => ({ bestFinalCount: 0, bestCombinedCount: 0 }));
    renderReport();
    setStatus('Report cleared', '#94a3b8');
  });

  // ---------------------------
  // Init
  // ---------------------------
  rebuildParagraphTokensAndProgress();
  renderHeader();
  renderParagraph();
  loadDefaultText();
  renderReport();

  setActiveTab('read');

  if (isSupported) {
    initRecognition();
    setStatus('Paused', '#94a3b8');
  }
})();
</script>
</body>
</html>
