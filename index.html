<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Wanderer - Read Along Trainer</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- html2canvas for Screenshots -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <!-- Custom Config for Tailwind colors if needed, keeping defaults is fine -->
    <style>
        /* Custom Scrollbar for the transcript box */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        /* Floating Bubble Animation */
        .bubble-enter {
            animation: popIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popIn {
            from { opacity: 0; transform: scale(0.8) translateY(10px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        /* Highlight classes */
        mark { color: inherit; border-radius: 4px; padding: 2px 0; cursor: pointer; }
        .hl-yellow { background-color: #fcd34d; }
        .hl-green { background-color: #86efac; }
        .hl-blue { background-color: #93c5fd; }
        .hl-pink { background-color: #f9a8d4; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans min-h-screen flex flex-col">

    <!-- Top Navigation / Header -->
    <header class="bg-white shadow-sm sticky top-0 z-40">
        <div class="max-w-4xl mx-auto px-4 py-3">
            <h1 class="text-xl font-bold text-slate-900 tracking-tight">THE WANDERER <span class="text-sm font-normal text-slate-500 ml-2">by Sharon Creech</span></h1>
            <p class="text-xs text-slate-500 italic mt-1">The main character, Sophie, is an orphan adopted by uncles. She is sailing across the Atlantic with her cousins.</p>
        </div>

        <!-- Tab Navigation -->
        <div class="flex max-w-4xl mx-auto px-4 mt-2 border-b border-slate-200 overflow-x-auto">
            <button onclick="app.switchTab('read')" id="tab-btn-read" class="tab-btn px-4 py-2 text-sm font-medium border-b-2 border-indigo-600 text-indigo-600 whitespace-nowrap">Tab A: Read Along</button>
            <button onclick="app.switchTab('report')" id="tab-btn-report" class="tab-btn px-4 py-2 text-sm font-medium border-b-2 border-transparent text-slate-500 hover:text-slate-700 whitespace-nowrap">Tab B: Report</button>
            <button onclick="app.switchTab('full')" id="tab-btn-full" class="tab-btn px-4 py-2 text-sm font-medium border-b-2 border-transparent text-slate-500 hover:text-slate-700 whitespace-nowrap">Tab C: Full Text & Highlight</button>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="flex-grow max-w-4xl mx-auto w-full p-4 relative">
        
        <!-- Browser Support Warning -->
        <div id="browser-warning" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4 relative" role="alert">
            <strong class="font-bold">Browser not supported.</strong>
            <span class="block sm:inline">Please use Google Chrome or Microsoft Edge for Speech Recognition features.</span>
        </div>

        <!-- Auto-save Indicator -->
        <div id="autosave-indicator" class="fixed bottom-4 right-4 bg-slate-800 text-white text-xs px-3 py-1 rounded-full opacity-0 transition-opacity duration-500 pointer-events-none z-50">
            Saved
        </div>

        <!-- TAB A: READ ALONG -->
        <section id="tab-read" class="space-y-6">
            <!-- Controls & Status Header -->
            <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-4">
                    <!-- Name Input -->
                    <div class="w-full md:w-auto">
                        <label for="student-name" class="block text-xs font-semibold text-slate-500 uppercase tracking-wider mb-1">Your Name *</label>
                        <input type="text" id="student-name" placeholder="Enter name to start..." class="w-full md:w-64 px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none transition-colors">
                    </div>

                    <!-- Status Pill -->
                    <div id="status-pill" class="px-4 py-1.5 rounded-full text-xs font-bold bg-slate-200 text-slate-600 flex items-center gap-2">
                        <span class="w-2 h-2 rounded-full bg-slate-400"></span>
                        Waiting for Name
                    </div>
                </div>

                <!-- Main Controls -->
                <div class="grid grid-cols-2 md:flex gap-2">
                    <button id="btn-start" disabled onclick="app.startReading()" class="col-span-2 md:col-span-1 bg-indigo-600 hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed text-white px-6 py-3 rounded-lg font-semibold shadow-sm transition-all active:scale-95 flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" /></svg>
                        Start Reading
                    </button>
                    
                    <button id="btn-stop" disabled onclick="app.stopReading()" class="bg-slate-100 hover:bg-slate-200 text-slate-700 px-4 py-2 rounded-lg font-medium transition-colors disabled:opacity-50">Pause</button>
                    <button onclick="app.restartParagraph()" class="bg-slate-100 hover:bg-slate-200 text-slate-700 px-4 py-2 rounded-lg font-medium transition-colors">Restart ¶</button>
                    
                    <div class="hidden md:block border-l border-slate-300 mx-2"></div>

                    <button onclick="app.changeParagraph(-1)" class="bg-white border border-slate-300 hover:bg-slate-50 text-slate-700 px-4 py-2 rounded-lg font-medium">Prev</button>
                    <button onclick="app.changeParagraph(1)" class="bg-white border border-slate-300 hover:bg-slate-50 text-slate-700 px-4 py-2 rounded-lg font-medium">Next</button>

                    <div class="ml-auto">
                        <select id="accent-selector" class="bg-slate-50 border border-slate-300 text-slate-700 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-2.5">
                            <option value="en-US">US English</option>
                            <option value="en-GB">UK English</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Reading Area -->
            <div class="bg-white p-6 md:p-10 rounded-xl shadow-lg border border-slate-100 min-h-[300px] relative">
                <div class="absolute top-4 right-4 text-xs font-bold text-slate-300 select-none">PARAGRAPH <span id="display-para-num">1</span></div>
                
                <!-- The Text Container -->
                <div id="read-display" class="text-2xl md:text-3xl leading-relaxed text-slate-400 font-serif select-none" ondblclick="app.handleBubbleClick(event)">
                    <!-- Words injected here -->
                </div>
            </div>

            <!-- Live Transcript -->
            <div class="bg-slate-900 text-emerald-400 p-4 rounded-lg font-mono text-sm h-24 overflow-y-auto shadow-inner border border-slate-700">
                <div class="text-xs text-slate-500 uppercase tracking-widest mb-1">Live Transcript</div>
                <div id="transcript-box" class="opacity-90">...</div>
            </div>
        </section>


        <!-- TAB B: REPORT -->
        <section id="tab-report" class="hidden space-y-6">
            <div id="report-card" class="bg-white p-8 rounded-xl shadow-lg border border-slate-200 max-w-2xl mx-auto">
                <div class="flex justify-between items-start border-b border-slate-100 pb-4 mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-slate-800">Performance Report</h2>
                        <p class="text-slate-500 text-sm">Paragraph <span id="report-para-num">1</span></p>
                    </div>
                    <div class="text-right">
                        <p id="report-student-name" class="font-bold text-indigo-600 text-lg"></p>
                        <p class="text-xs text-slate-400" id="report-date"></p>
                    </div>
                </div>

                <!-- Stats Grid -->
                <div class="grid grid-cols-3 gap-4 mb-8">
                    <div class="text-center p-4 bg-slate-50 rounded-xl">
                        <div class="text-xs text-slate-500 uppercase font-bold">Total Words</div>
                        <div id="stat-total" class="text-3xl font-bold text-slate-700">0</div>
                    </div>
                    <div class="text-center p-4 bg-green-50 rounded-xl">
                        <div class="text-xs text-green-600 uppercase font-bold">Correct</div>
                        <div id="stat-correct" class="text-3xl font-bold text-green-600">0</div>
                    </div>
                    <div class="text-center p-4 bg-indigo-50 rounded-xl">
                        <div class="text-xs text-indigo-600 uppercase font-bold">Accuracy</div>
                        <div id="stat-accuracy" class="text-3xl font-bold text-indigo-600">0%</div>
                    </div>
                </div>

                <!-- Progress Bar Visual -->
                <div class="mb-8">
                    <div class="h-4 w-full bg-slate-200 rounded-full overflow-hidden">
                        <div id="accuracy-bar" class="h-full bg-indigo-500 transition-all duration-1000" style="width: 0%"></div>
                    </div>
                </div>

                <!-- Word Breakdown -->
                <h3 class="text-sm font-bold text-slate-700 mb-3">Word Breakdown (Double-click words for help)</h3>
                <div id="report-words" class="flex flex-wrap gap-2" ondblclick="app.handleBubbleClick(event)">
                    <!-- Word Chips -->
                </div>

                <!-- Actions -->
                <div class="mt-8 pt-6 border-t border-slate-100 text-center">
                    <button onclick="app.downloadReport()" class="bg-slate-800 hover:bg-slate-900 text-white px-6 py-2 rounded-lg text-sm font-medium shadow-lg transition-transform active:scale-95">
                        Download Report Image
                    </button>
                </div>
            </div>
        </section>


        <!-- TAB C: FULL TEXT & HIGHLIGHT -->
        <section id="tab-full" class="hidden grid md:grid-cols-3 gap-6 h-[calc(100vh-140px)]">
            
            <!-- Left: Highlights Panel -->
            <div class="md:col-span-1 bg-white rounded-xl shadow-sm border border-slate-200 flex flex-col overflow-hidden">
                <div class="p-4 bg-slate-50 border-b border-slate-200">
                    <h3 class="font-bold text-slate-700">Highlighted Fragments</h3>
                </div>
                
                <div id="fragments-container" class="p-4 overflow-y-auto flex-grow space-y-4">
                    <!-- Dynamic Fragment Groups -->
                    <p class="text-sm text-slate-400 italic text-center mt-10">(No highlights yet)</p>
                </div>
            </div>

            <!-- Right: Text & Tools -->
            <div class="md:col-span-2 flex flex-col gap-4 h-full">
                <!-- Toolbar -->
                <div class="bg-white p-3 rounded-xl shadow-sm border border-slate-200 flex flex-wrap gap-2 items-center justify-between">
                    <div class="flex gap-2 items-center">
                        <span class="text-xs font-bold text-slate-400 mr-2">COLOR:</span>
                        <!-- Color Palette -->
                        <button onclick="app.setHighlightColor('hl-yellow')" class="w-8 h-8 rounded-full bg-yellow-300 hover:scale-110 transition-transform ring-2 ring-offset-1 ring-transparent focus:ring-slate-400" data-color="hl-yellow"></button>
                        <button onclick="app.setHighlightColor('hl-green')" class="w-8 h-8 rounded-full bg-green-300 hover:scale-110 transition-transform ring-2 ring-offset-1 ring-transparent focus:ring-slate-400" data-color="hl-green"></button>
                        <button onclick="app.setHighlightColor('hl-blue')" class="w-8 h-8 rounded-full bg-blue-300 hover:scale-110 transition-transform ring-2 ring-offset-1 ring-transparent focus:ring-slate-400" data-color="hl-blue"></button>
                        <button onclick="app.setHighlightColor('hl-pink')" class="w-8 h-8 rounded-full bg-pink-300 hover:scale-110 transition-transform ring-2 ring-offset-1 ring-transparent focus:ring-slate-400" data-color="hl-pink"></button>
                    </div>

                    <div class="flex gap-2">
                        <button onclick="app.applyHighlight()" class="bg-indigo-100 text-indigo-700 hover:bg-indigo-200 px-3 py-1.5 rounded text-sm font-bold flex items-center gap-1">
                            <span class="text-lg">✎</span> Highlight
                        </button>
                        <button onclick="app.clearHighlights()" class="bg-slate-100 text-slate-600 hover:bg-slate-200 px-3 py-1.5 rounded text-sm font-bold">
                            Clear All
                        </button>
                    </div>
                </div>

                <!-- Full Text Scrollable -->
                <div id="full-text-container" class="bg-white p-8 rounded-xl shadow-sm border border-slate-200 overflow-y-auto flex-grow font-serif text-lg leading-relaxed text-slate-800" ondblclick="app.handleBubbleClick(event)">
                    <!-- Content injected via JS -->
                </div>
            </div>
        </section>

        <!-- FLOATING BUBBLE (Shared) -->
        <div id="helper-bubble" class="hidden fixed z-50 bg-slate-900 text-white p-4 rounded-xl shadow-2xl max-w-xs w-64 bubble-enter">
            <div class="flex justify-between items-start mb-2">
                <h4 id="bubble-word" class="text-xl font-bold text-white capitalize">Word</h4>
                <button onclick="app.closeBubble()" class="text-slate-400 hover:text-white">&times;</button>
            </div>
            
            <div class="flex gap-2 mb-3">
                <button onclick="app.speakWord(1)" class="bg-indigo-600 hover:bg-indigo-500 text-white px-3 py-1 rounded text-xs font-bold">Play</button>
                <button onclick="app.speakWord(0.5)" class="bg-slate-700 hover:bg-slate-600 text-white px-3 py-1 rounded text-xs font-bold">Slow</button>
                <button onclick="app.speakWord(1, 2)" class="bg-slate-700 hover:bg-slate-600 text-white px-3 py-1 rounded text-xs font-bold">x2</button>
            </div>

            <div id="bubble-def" class="text-xs text-slate-300 border-t border-slate-700 pt-2">
                <!-- Content dynamically filled -->
            </div>
        </div>

    </main>

    <!-- JS LOGIC -->
    <script>
        /**
         * APPLICATION DATA
         * Defined content strictly as requested.
         */
        const BOOK_DATA = {
            title: "THE WANDERER",
            paragraphs: [
                "I am not always such a dreamy girl, listening to the sea calling me. My father calls me Three sided Sophie: one side is dreamy and romantic; one is logical and down to earth; and the third side is hardheaded and impulsive. He says I am either in dreamland or earthland or mule land, and if I ever get the three together, I'll be all set, though I wonder where I will be then. If I'm not in dreamland or earthland or mule land, where will I be?",
                "My father says my logical side is most like him, and the dreamy side most like my mother, which isn't entirely fair, I don't think. My father likes to think of himself as a logical man, but he is the one who pores over pictures of exotic lands and says things like \"We should go on a safari!\" and \"We should zip through the air in a hot air balloon!\"",
                "And although my mother is a weaver and spins silky cloths and wears flowing dresses, she is the one who gives me sailing textbooks and makes me study water safety and weather prediction and says things like \"Yes, Sophie, I taught you to sail, but that doesn't mean I like the idea of you being out there alone on the water. I want you to stay home. Here. With me. Safe.\"",
                "My father says he doesn't know who my hardheaded mule side resembles. He says mules don't run in the family. I am thirteen, and I am going to sail across the ocean. Although I would like to go alone alone! alone! flying over the water! I'm not.",
                "My mule self begged a place aboard a forty five foot sailboat with a motley crew: three uncles and two cousins. The uncles Stew, Mo, and Dock are my mother's brothers, and she told them, \"If the slightest harm comes to my Sophie, I'll string you all up by your toes.\""
            ]
        };

        /**
         * STATE MANAGEMENT
         */
        const app = {
            state: {
                currentTab: 'read',
                currentParagraph: 0,
                studentName: '',
                isListening: false,
                accent: 'en-US',
                matchedIndices: [], // Set of indices of words correctly matched in current para
                // We will also store a map of matched indices for ALL paragraphs for persistence
                allProgress: {}, // { 0: [1,2], 1: [] }
                currentHighlightColor: 'hl-yellow',
                recognition: null,
                bubbleWord: null,
                processedWords: [] // Array of {word, cleanWord, matched} for current para
            },

            elements: {
                tabs: ['read', 'report', 'full'],
                readDisplay: document.getElementById('read-display'),
                transcriptBox: document.getElementById('transcript-box'),
                statusPill: document.getElementById('status-pill'),
                nameInput: document.getElementById('student-name'),
                startBtn: document.getElementById('btn-start'),
                stopBtn: document.getElementById('btn-stop'),
                fullTextContainer: document.getElementById('full-text-container'),
                fragmentsContainer: document.getElementById('fragments-container'),
                bubble: document.getElementById('helper-bubble')
            },

            /**
             * INITIALIZATION
             */
            init() {
                // Check Support
                if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                    document.getElementById('browser-warning').classList.remove('hidden');
                    this.elements.startBtn.disabled = true;
                    this.elements.startBtn.textContent = "Not Supported";
                    return;
                }

                // Initial Render (needed before loading state for highlights)
                this.renderFullText();

                // LOAD STATE FROM LOCALSTORAGE
                this.loadState();

                // Initialize Text Processing for Para (use loaded state if available)
                this.loadParagraph(this.state.currentParagraph);
                
                // Name Input Listener
                this.elements.nameInput.addEventListener('input', (e) => {
                    this.state.studentName = e.target.value;
                    this.updateControls();
                    this.saveState(); // Autosave
                });

                // Set Date
                const now = new Date();
                document.getElementById('report-date').textContent = now.toLocaleDateString() + ' ' + now.toLocaleTimeString();

                this.updateControls();
                this.updateFragmentsPanel(); // Refresh highlight panel after load
            },

            /**
             * AUTOSAVE LOGIC
             */
            saveState() {
                const data = {
                    studentName: this.state.studentName,
                    currentParagraph: this.state.currentParagraph,
                    // Save matches for current paragraph into the map
                    allProgress: {
                        ...this.state.allProgress,
                        [this.state.currentParagraph]: this.state.matchedIndices
                    },
                    // Save Highlights (innerHTML is simplest for single file persistence)
                    highlightsHTML: this.elements.fullTextContainer.innerHTML
                };
                
                try {
                    localStorage.setItem('wanderer_app_state', JSON.stringify(data));
                    // Visual feedback
                    const indicator = document.getElementById('autosave-indicator');
                    indicator.style.opacity = '1';
                    setTimeout(() => indicator.style.opacity = '0', 1000);
                } catch (e) {
                    console.error("Autosave failed (quota exceeded?)", e);
                }
            },

            loadState() {
                try {
                    const saved = localStorage.getItem('wanderer_app_state');
                    if (saved) {
                        const data = JSON.parse(saved);
                        
                        if (data.studentName) {
                            this.state.studentName = data.studentName;
                            this.elements.nameInput.value = data.studentName;
                        }
                        
                        if (typeof data.currentParagraph === 'number') {
                            this.state.currentParagraph = data.currentParagraph;
                        }

                        if (data.allProgress) {
                            this.state.allProgress = data.allProgress;
                        }

                        // Restore Highlights
                        if (data.highlightsHTML) {
                            this.elements.fullTextContainer.innerHTML = data.highlightsHTML;
                        }
                    }
                } catch (e) {
                    console.error("Load state failed", e);
                }
            },

            /**
             * CORE UI LOGIC
             */
            switchTab(tabId) {
                this.state.currentTab = tabId;
                
                // Update Buttons
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    const isActive = btn.id === `tab-btn-${tabId}`;
                    btn.classList.toggle('border-indigo-600', isActive);
                    btn.classList.toggle('text-indigo-600', isActive);
                    btn.classList.toggle('border-transparent', !isActive);
                    btn.classList.toggle('text-slate-500', !isActive);
                });

                // Update Sections
                this.elements.tabs.forEach(t => {
                    const el = document.getElementById(`tab-${t}`);
                    if (t === tabId) {
                        el.classList.remove('hidden');
                        if (t === 'read') this.elements.readDisplay.scrollTop = 0; // Reset scroll
                        if (t === 'report') this.renderReport();
                        if (t === 'full') this.updateFragmentsPanel();
                    } else {
                        el.classList.add('hidden');
                    }
                });

                // Auto-pause if leaving read tab
                if (tabId !== 'read' && this.state.isListening) {
                    this.stopReading();
                }
            },

            updateControls() {
                const hasName = this.state.studentName.trim().length > 0;
                
                // Status Pill Logic
                const pill = this.elements.statusPill;
                const dot = pill.querySelector('span');
                
                if (!hasName) {
                    pill.className = "px-4 py-1.5 rounded-full text-xs font-bold bg-slate-200 text-slate-600 flex items-center gap-2";
                    dot.className = "w-2 h-2 rounded-full bg-slate-400";
                    pill.childNodes[2].textContent = "Enter Name First";
                    this.elements.startBtn.disabled = true;
                } else if (this.state.isListening) {
                    pill.className = "px-4 py-1.5 rounded-full text-xs font-bold bg-green-100 text-green-700 flex items-center gap-2 animate-pulse";
                    dot.className = "w-2 h-2 rounded-full bg-green-500";
                    pill.childNodes[2].textContent = "Listening...";
                    this.elements.startBtn.disabled = true;
                    this.elements.stopBtn.disabled = false;
                } else {
                    pill.className = "px-4 py-1.5 rounded-full text-xs font-bold bg-indigo-50 text-indigo-700 flex items-center gap-2";
                    dot.className = "w-2 h-2 rounded-full bg-indigo-500";
                    pill.childNodes[2].textContent = "Ready to Read";
                    this.elements.startBtn.disabled = false;
                    this.elements.stopBtn.disabled = true;
                }
            },

            /**
             * READ MODE LOGIC
             */
            loadParagraph(index) {
                // Bounds check
                if (index < 0) index = 0;
                if (index >= BOOK_DATA.paragraphs.length) index = BOOK_DATA.paragraphs.length - 1;

                // Stop reading if switching
                if (this.state.isListening) {
                   this.stopReading();
                }
                
                this.state.currentParagraph = index;
                document.getElementById('display-para-num').textContent = index + 1;

                // Process Text -> Words
                const rawText = BOOK_DATA.paragraphs[index];
                const words = rawText.split(/\s+/);
                
                this.state.processedWords = words.map((w, i) => ({
                    original: w,
                    clean: w.replace(/[^\w]/g, '').toLowerCase(),
                    index: i
                }));

                // Load progress if available, else empty
                this.state.matchedIndices = this.state.allProgress[index] || [];

                this.renderReadDisplay();
                this.elements.transcriptBox.textContent = "...";
                
                this.saveState(); // Save current paragraph position
            },

            renderReadDisplay() {
                const container = this.elements.readDisplay;
                container.innerHTML = '';

                this.state.processedWords.forEach((wordObj, i) => {
                    const span = document.createElement('span');
                    span.textContent = wordObj.original + ' '; // Add space back
                    span.dataset.index = i;
                    span.dataset.clean = wordObj.clean;
                    span.className = "inline-block py-1 px-1 rounded transition-colors duration-200 cursor-pointer hover:bg-slate-50";
                    
                    // Style based on match status
                    if (this.state.matchedIndices.includes(i)) {
                        span.classList.add('text-green-600', 'font-bold');
                    } else {
                        span.classList.add('text-slate-400');
                    }

                    // Visual indicator of current position (first unmatched word)
                    const lastMatched = this.state.matchedIndices.length > 0 ? Math.max(...this.state.matchedIndices) : -1;
                    if (i === lastMatched + 1) {
                         span.classList.add('underline', 'decoration-indigo-300', 'decoration-4', 'underline-offset-4', 'text-slate-600');
                    }

                    container.appendChild(span);
                });
            },

            changeParagraph(direction) {
                const newIndex = this.state.currentParagraph + direction;
                if (newIndex >= 0 && newIndex < BOOK_DATA.paragraphs.length) {
                    this.loadParagraph(newIndex);
                }
            },

            restartParagraph() {
                this.stopReading();
                this.state.matchedIndices = [];
                // Update persistent progress
                this.state.allProgress[this.state.currentParagraph] = [];
                this.renderReadDisplay();
                this.elements.transcriptBox.textContent = "...";
                this.saveState();
            },

            /**
             * SPEECH RECOGNITION
             */
            startReading() {
                if (this.state.isListening) return;

                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                this.state.recognition = new SpeechRecognition();
                
                // Config
                this.state.recognition.lang = document.getElementById('accent-selector').value;
                this.state.recognition.continuous = true;
                this.state.recognition.interimResults = true;

                this.state.recognition.onstart = () => {
                    this.state.isListening = true;
                    this.updateControls();
                };

                this.state.recognition.onend = () => {
                    // Auto restart if supposedly listening (fixes silence timeouts)
                    if (this.state.isListening) {
                        try { this.state.recognition.start(); } catch(e) { this.state.isListening = false; this.updateControls(); }
                    } else {
                        this.updateControls();
                    }
                };

                this.state.recognition.onerror = (event) => {
                    console.error("Speech Error", event.error);
                    if (event.error === 'not-allowed') {
                        alert("Microphone access denied. Please allow microphone access.");
                        this.state.isListening = false;
                        this.updateControls();
                    }
                };

                this.state.recognition.onresult = (event) => {
                    let interimTranscript = '';
                    let finalTranscript = '';

                    for (let i = event.resultIndex; i < event.results.length; ++i) {
                        if (event.results[i].isFinal) {
                            finalTranscript += event.results[i][0].transcript;
                            this.processMatch(event.results[i][0].transcript);
                        } else {
                            interimTranscript += event.results[i][0].transcript;
                        }
                    }
                    
                    // Live feedback
                    this.elements.transcriptBox.textContent = interimTranscript || (finalTranscript.slice(-50)) || "...";
                };

                this.state.recognition.start();
            },

            stopReading() {
                this.state.isListening = false;
                if (this.state.recognition) {
                    this.state.recognition.stop();
                }
                this.updateControls();
            },

            processMatch(transcript) {
                // Tokenize input
                const inputWords = transcript.toLowerCase().replace(/[^\w\s]/g, '').trim().split(/\s+/);
                
                // Where are we in the paragraph?
                const words = this.state.processedWords;
                let lastMatchedIndex = this.state.matchedIndices.length > 0 ? Math.max(...this.state.matchedIndices) : -1;
                let searchStartIndex = lastMatchedIndex + 1;

                if (searchStartIndex >= words.length) return; // Paragraph done

                let madeMatch = false;

                // Simple sliding window match
                inputWords.forEach(spokenWord => {
                    if (searchStartIndex < words.length) {
                        const target = words[searchStartIndex].clean;
                        if (spokenWord === target) {
                            // Match!
                            this.state.matchedIndices.push(searchStartIndex);
                            searchStartIndex++;
                            madeMatch = true;
                        }
                    }
                });

                if (madeMatch) {
                    this.renderReadDisplay();
                    this.saveState(); // Autosave matched progress
                    
                    // Scroll to active word logic
                    const activeSpan = this.elements.readDisplay.querySelector(`span[data-index="${searchStartIndex}"]`);
                    if (activeSpan) {
                         activeSpan.scrollIntoView({ behavior: "smooth", block: "center" });
                    }
                }
            },

            /**
             * REPORT GENERATION
             */
            renderReport() {
                // Update Header info
                document.getElementById('report-student-name').textContent = this.state.studentName || "Guest Student";
                document.getElementById('report-para-num').textContent = this.state.currentParagraph + 1;

                // Calculate Stats
                const total = this.state.processedWords.length;
                const correct = this.state.matchedIndices.length;
                const percent = total === 0 ? 0 : Math.round((correct / total) * 100);

                // Update DOM
                document.getElementById('stat-total').textContent = total;
                document.getElementById('stat-correct').textContent = correct;
                document.getElementById('stat-accuracy').textContent = percent + '%';
                
                // Animate Bar
                setTimeout(() => {
                    document.getElementById('accuracy-bar').style.width = percent + '%';
                    // Color code bar
                    const bar = document.getElementById('accuracy-bar');
                    if (percent < 50) bar.className = "h-full bg-red-500 transition-all duration-1000";
                    else if (percent < 80) bar.className = "h-full bg-yellow-400 transition-all duration-1000";
                    else bar.className = "h-full bg-green-500 transition-all duration-1000";
                }, 100);

                // Word Breakdown
                const chipContainer = document.getElementById('report-words');
                chipContainer.innerHTML = '';
                
                this.state.processedWords.forEach((w, i) => {
                    const isCorrect = this.state.matchedIndices.includes(i);
                    const chip = document.createElement('span');
                    chip.textContent = w.original;
                    chip.className = `px-2 py-1 rounded text-xs font-bold cursor-pointer transition-colors border ${
                        isCorrect 
                        ? 'bg-green-100 text-green-800 border-green-200 hover:bg-green-200' 
                        : 'bg-red-100 text-red-800 border-red-200 hover:bg-red-200'
                    }`;
                    chipContainer.appendChild(chip);
                });
            },

            downloadReport() {
                const reportCard = document.getElementById('report-card');
                html2canvas(reportCard, { scale: 2, backgroundColor: "#ffffff" }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = `ReadingReport_${this.state.studentName || 'Student'}_P${this.state.currentParagraph+1}.png`;
                    link.href = canvas.toDataURL();
                    link.click();
                });
            },

            /**
             * FULL TEXT & HIGHLIGHTING
             */
            renderFullText() {
                // Only render initial structure if empty (so we don't overwrite loaded highlights)
                const container = this.elements.fullTextContainer;
                if (container.children.length > 0) return;

                BOOK_DATA.paragraphs.forEach((para, index) => {
                    const p = document.createElement('p');
                    p.className = "mb-6";
                    p.innerHTML = `<span class="font-bold text-slate-300 mr-2">${index + 1}</span>` + para;
                    container.appendChild(p);
                });
            },

            setHighlightColor(colorClass) {
                this.state.currentHighlightColor = colorClass;
                // Visual feedback on palette
                document.querySelectorAll('[data-color]').forEach(btn => {
                    if (btn.dataset.color === colorClass) {
                        btn.classList.add('ring-slate-400');
                    } else {
                        btn.classList.remove('ring-slate-400');
                    }
                });
            },

            applyHighlight() {
                const selection = window.getSelection();
                if (!selection.rangeCount) return;

                const range = selection.getRangeAt(0);
                // Ensure selection is within the full text container
                if (!this.elements.fullTextContainer.contains(range.commonAncestorContainer)) return;

                const mark = document.createElement('mark');
                mark.className = this.state.currentHighlightColor;
                
                try {
                    range.surroundContents(mark);
                    selection.removeAllRanges(); // Clear selection
                    this.updateFragmentsPanel();
                    this.saveState(); // Autosave Highlights
                } catch (e) {
                    alert("Cannot highlight across multiple paragraphs or overlapping elements.");
                }
            },

            clearHighlights() {
                // Remove all marks but keep text
                const marks = this.elements.fullTextContainer.querySelectorAll('mark');
                marks.forEach(mark => {
                    const parent = mark.parentNode;
                    while (mark.firstChild) parent.insertBefore(mark.firstChild, mark);
                    parent.removeChild(mark);
                });
                this.updateFragmentsPanel();
                this.saveState(); // Autosave Highlights
            },

            updateFragmentsPanel() {
                const panel = this.elements.fragmentsContainer;
                panel.innerHTML = '';
                
                // Group by color
                const colors = ['hl-yellow', 'hl-green', 'hl-blue', 'hl-pink'];
                const colorNames = { 'hl-yellow': 'Yellow', 'hl-green': 'Green', 'hl-blue': 'Blue', 'hl-pink': 'Pink' };
                const marks = Array.from(this.elements.fullTextContainer.querySelectorAll('mark'));

                if (marks.length === 0) {
                    panel.innerHTML = '<p class="text-sm text-slate-400 italic text-center mt-10">(No highlights yet)</p>';
                    return;
                }

                colors.forEach(color => {
                    const colorMarks = marks.filter(m => m.classList.contains(color));
                    if (colorMarks.length > 0) {
                        // Section Header
                        const header = document.createElement('div');
                        header.className = "text-xs font-bold uppercase tracking-wide text-slate-500 mt-4 mb-2 pb-1 border-b border-slate-100";
                        header.textContent = colorNames[color];
                        panel.appendChild(header);

                        // Fragments
                        colorMarks.forEach(mark => {
                            const card = document.createElement('div');
                            card.className = "bg-slate-50 border border-slate-100 p-2 rounded text-sm text-slate-700 mb-2 cursor-pointer hover:bg-indigo-50 hover:border-indigo-200 transition-colors line-clamp-2";
                            card.textContent = mark.textContent;
                            card.onclick = () => {
                                mark.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                // Temporary flash effect
                                mark.style.opacity = '0.5';
                                setTimeout(() => mark.style.opacity = '1', 300);
                            };
                            panel.appendChild(card);
                        });
                    }
                });
            },

            /**
             * BUBBLE & HELPERS
             */
            handleBubbleClick(event) {
                // Get clicked word
                const selection = window.getSelection();
                // Basic cleanup: remove punctuation
                const word = selection.toString().trim().replace(/[.,!?;:"()]/g, '');
                
                if (word && word.length > 1) {
                    this.showBubble(word, event.pageX, event.pageY);
                }
            },

            async showBubble(word, x, y) {
                const bubble = this.elements.bubble;
                this.state.bubbleWord = word;
                document.getElementById('bubble-word').textContent = word;
                
                // Position Bubble
                bubble.style.left = `${Math.min(x - 20, window.innerWidth - 300)}px`; // Prevent overflow right
                bubble.style.top = `${y + 20}px`;
                bubble.classList.remove('hidden');

                // Dictionary Fetch Logic
                const defContainer = document.getElementById('bubble-def');
                defContainer.innerHTML = '<p class="italic text-slate-400">Loading definition...</p>';

                try {
                    const response = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${word}`);
                    if (!response.ok) throw new Error('Not found');
                    const data = await response.json();
                    
                    if (Array.isArray(data) && data.length > 0) {
                        const firstEntry = data[0];
                        const meaning = firstEntry.meanings[0];
                        const partOfSpeech = meaning.partOfSpeech || 'unknown';
                        const def = meaning.definitions[0].definition;
                        
                        defContainer.innerHTML = `
                            <div class="text-sm">
                                <span class="font-bold text-indigo-400 text-xs uppercase mr-1">${partOfSpeech}</span>
                                <span class="text-slate-200">${def}</span>
                            </div>
                        `;
                    } else {
                        throw new Error('No definitions found');
                    }
                } catch (e) {
                    // Fallback to link if API fails
                    defContainer.innerHTML = `
                        <div class="text-center">
                            <p class="text-xs text-red-300 mb-2">Definition unavailable.</p>
                            <a href="https://www.wordreference.com/definition/${word}" 
                               target="_blank"
                               class="text-indigo-400 hover:text-indigo-300 underline text-xs">
                               Check WordReference ↗
                            </a>
                        </div>
                    `;
                }

                // Close on click outside
                const closeHandler = (e) => {
                    // Allow clicking inside the bubble (especially the link)
                    if (bubble.contains(e.target)) return;
                    
                    if (!bubble.contains(e.target) && e.target.tagName !== 'SPAN' && e.target.tagName !== 'MARK') {
                        this.closeBubble();
                        document.removeEventListener('click', closeHandler);
                    }
                };
                setTimeout(() => document.addEventListener('click', closeHandler), 100);
            },

            closeBubble() {
                this.elements.bubble.classList.add('hidden');
                window.getSelection().removeAllRanges();
            },

            speakWord(rate, repeats = 1) {
                if (!this.state.bubbleWord) return;
                
                const utterance = new SpeechSynthesisUtterance(this.state.bubbleWord);
                utterance.rate = rate;
                utterance.lang = document.getElementById('accent-selector').value;

                let count = 0;
                utterance.onend = () => {
                    count++;
                    if (count < repeats) {
                        window.speechSynthesis.speak(utterance);
                    }
                };
                window.speechSynthesis.speak(utterance);
            }
        };

        // Boot
        window.addEventListener('DOMContentLoaded', () => app.init());

    </script>
</body>
</html>
