<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Read-Along (EFL) — Web Speech API</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    #pronounceBubble { will-change: transform; }
  </style>
</head>

<body class="min-h-screen bg-slate-50 text-slate-900">
  <div class="mx-auto max-w-4xl px-4 py-6 sm:py-10">
    <!-- Header -->
    <header class="mb-6 sm:mb-8">
      <div class="flex flex-col gap-2 sm:flex-row sm:items-end sm:justify-between">
        <div>
          <h1 id="title" class="text-2xl sm:text-3xl font-bold tracking-tight">
            THE WANDERER <span class="text-slate-500 font-semibold">by Sharon Creech</span>
          </h1>
          <p id="context" class="mt-2 text-sm sm:text-base italic text-slate-600">
            The main character, Sophie, is an orphan adopted by uncles. She is sailing across the Atlantic with her cousins.
          </p>
        </div>

        <div class="flex items-center gap-2">
          <span class="inline-flex items-center gap-2 rounded-full bg-white px-3 py-1 text-xs sm:text-sm shadow-sm ring-1 ring-slate-200">
            <span class="h-2.5 w-2.5 rounded-full" id="statusDot" style="background:#94a3b8"></span>
            <span id="statusText" class="text-slate-700">Paused</span>
          </span>
        </div>
      </div>
    </header>

    <!-- Unsupported Browser Warning -->
    <div id="unsupported" class="hidden mb-6 rounded-xl border border-amber-200 bg-amber-50 p-4 text-amber-900">
      <p class="font-semibold">Browser not supported.</p>
      <p class="mt-1 text-sm">
        Please use Google Chrome or Microsoft Edge (desktop or Android). Some iOS versions and Firefox may not support the Web Speech API.
      </p>
    </div>

    <!-- Main Card -->
    <main class="rounded-2xl bg-white shadow-sm ring-1 ring-slate-200">
      <div class="p-4 sm:p-6">

        <!-- Tabs -->
        <div class="mb-4 grid grid-cols-3 gap-2">
          <button id="tabRead"
            class="inline-flex items-center justify-center rounded-xl px-4 py-3 text-base font-semibold shadow-sm ring-1 ring-slate-200 focus:outline-none focus:ring-4 focus:ring-slate-200">
            Read Along
          </button>
          <button id="tabReport"
            class="inline-flex items-center justify-center rounded-xl px-4 py-3 text-base font-semibold shadow-sm ring-1 ring-slate-200 focus:outline-none focus:ring-4 focus:ring-slate-200">
            Paragraph Report
          </button>
          <button id="tabText"
            class="inline-flex items-center justify-center rounded-xl px-4 py-3 text-base font-semibold shadow-sm ring-1 ring-slate-200 focus:outline-none focus:ring-4 focus:ring-slate-200">
            Full Text & Highlight
          </button>
        </div>

        <!-- READ TAB -->
        <div id="readTab" class="flex flex-col gap-3 sm:gap-4">
          <!-- Student Name (Mandatory) -->
          <section class="rounded-2xl bg-white p-4 sm:p-6 ring-1 ring-slate-200">
            <div class="flex flex-col gap-2 sm:flex-row sm:items-end sm:justify-between">
              <div class="flex-1">
                <label for="studentName" class="text-sm font-bold text-slate-900">
                  Your name <span class="text-rose-600">*</span>
                </label>
                <p class="text-xs text-slate-600 mt-1">You must enter your name before you can start reading.</p>
                <input id="studentName" type="text" inputmode="text" autocomplete="name"
                  placeholder="Type your full name"
                  class="mt-2 w-full rounded-xl border border-slate-200 bg-white px-3 py-3 text-base shadow-sm focus:outline-none focus:ring-4 focus:ring-slate-200" />
                <p id="nameError" class="hidden mt-2 text-sm font-semibold text-rose-700">Please enter your name.</p>
              </div>
              <div class="sm:pl-4">
                <div class="inline-flex items-center gap-2 rounded-xl bg-slate-50 px-3 py-2 text-xs font-semibold text-slate-700 ring-1 ring-slate-200">
                  This name will appear on the report screenshot.
                </div>
              </div>
            </div>
          </section>

          <div class="flex flex-col gap-3 sm:flex-row sm:items-end sm:justify-between">
            <div class="grid grid-cols-2 gap-2 sm:flex sm:gap-3">
              <button id="micBtn"
                class="col-span-2 sm:col-auto inline-flex items-center justify-center rounded-xl bg-slate-900 px-4 py-3 text-base font-semibold text-white shadow-sm hover:bg-slate-800 active:scale-[0.99] focus:outline-none focus:ring-4 focus:ring-slate-200">
                Start Reading
              </button>

              <button id="prevBtn"
                class="inline-flex items-center justify-center rounded-xl bg-white px-4 py-3 text-base font-semibold text-slate-900 shadow-sm ring-1 ring-slate-200 hover:bg-slate-50 active:scale-[0.99] focus:outline-none focus:ring-4 focus:ring-slate-200">
                Previous
              </button>

              <button id="nextBtn"
                class="inline-flex items-center justify-center rounded-xl bg-white px-4 py-3 text-base font-semibold text-slate-900 shadow-sm ring-1 ring-slate-200 hover:bg-slate-50 active:scale-[0.99] focus:outline-none focus:ring-4 focus:ring-slate-200">
                Next
              </button>

              <button id="restartBtn"
                class="col-span-2 sm:col-auto inline-flex items-center justify-center rounded-xl bg-white px-4 py-3 text-base font-semibold text-slate-900 shadow-sm ring-1 ring-slate-200 hover:bg-slate-50 active:scale-[0.99] focus:outline-none focus:ring-4 focus:ring-slate-200">
                Restart Paragraph
              </button>
            </div>

            <div class="flex flex-col gap-2 sm:items-end">
              <label class="text-sm font-medium text-slate-700" for="langSelect">Recognition Accent</label>
              <select id="langSelect"
                class="w-full sm:w-56 rounded-xl border border-slate-200 bg-white px-3 py-3 text-base shadow-sm focus:outline-none focus:ring-4 focus:ring-slate-200">
                <option value="en-US" selected>English (US) — en-US</option>
                <option value="en-GB">English (UK) — en-GB</option>
              </select>
            </div>
          </div>

          <!-- Paragraph Area -->
          <section aria-label="Reading paragraph" class="rounded-2xl bg-slate-50 p-4 sm:p-6 ring-1 ring-slate-200">
            <div class="flex items-center justify-between gap-3">
              <p class="text-xs sm:text-sm font-semibold text-slate-600">
                Paragraph <span id="paraIdx">1</span> / <span id="paraTotal">5</span>
              </p>
              <p class="text-xs sm:text-sm text-slate-500" id="hint">
                Tip: Words turn green as the engine recognizes them. Double-click a word to see pronunciation + definition.
              </p>
            </div>

            <div class="mt-4 text-lg sm:text-xl leading-relaxed text-slate-900" id="paragraphDisplay"></div>

            <div class="mt-5">
              <div class="flex items-center justify-between">
                <p class="text-xs sm:text-sm font-semibold text-slate-700">Live transcript (what the computer hears)</p>
                <button id="clearTranscript" class="text-xs sm:text-sm font-semibold text-slate-700 hover:text-slate-900">
                  Clear
                </button>
              </div>

              <div class="mt-2 rounded-xl bg-white p-3 sm:p-4 text-sm sm:text-base text-slate-700 shadow-sm ring-1 ring-slate-200" id="transcriptBox">
                <span class="text-slate-400">(interim results will appear here)</span>
              </div>
            </div>
          </section>

          <footer class="pt-1 pb-2">
            <p class="text-xs text-slate-500">
              Privacy: Audio is processed locally by your browser using the Web Speech API. Pronunciation playback uses on-device Speech Synthesis. Definitions use a free dictionary endpoint (no audio) and send only the clicked word.
            </p>
          </footer>
        </div>

        <!-- PARAGRAPH REPORT TAB -->
        <div id="reportTabPanel" class="hidden">
          <div id="reportCapture" class="rounded-2xl bg-slate-50 p-4 sm:p-6 ring-1 ring-slate-200">
            <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
              <div>
                <h2 class="text-lg sm:text-xl font-bold">Paragraph Report</h2>
                <p class="text-sm text-slate-600">
                  Student: <span id="reportStudent" class="font-semibold text-slate-900">—</span>
                  <span class="mx-2 text-slate-300">•</span>
                  Paragraph: <span id="reportPara" class="font-semibold text-slate-900">1</span> / <span id="reportParaTotal" class="font-semibold text-slate-900">5</span>
                </p>
                <p class="text-sm text-slate-600 mt-1">
                  This report only shows the <span class="font-semibold">current paragraph</span> (shorter screenshot).
                </p>
              </div>

              <div class="grid grid-cols-2 sm:flex gap-2">
                <button id="refreshReport"
                  class="inline-flex items-center justify-center rounded-xl bg-white px-4 py-3 text-base font-semibold text-slate-900 shadow-sm ring-1 ring-slate-200 hover:bg-slate-50 active:scale-[0.99] focus:outline-none focus:ring-4 focus:ring-slate-200">
                  Refresh
                </button>
                <button id="resetThisPara"
                  class="inline-flex items-center justify-center rounded-xl bg-white px-4 py-3 text-base font-semibold text-slate-900 shadow-sm ring-1 ring-slate-200 hover:bg-slate-50 active:scale-[0.99] focus:outline-none focus:ring-4 focus:ring-slate-200">
                  Reset Paragraph Result
                </button>
              </div>
            </div>

            <div class="mt-4 grid gap-3 sm:grid-cols-5">
              <div class="sm:col-span-3 grid gap-3 sm:grid-cols-3">
                <div class="rounded-2xl bg-white p-4 shadow-sm ring-1 ring-slate-200">
                  <p class="text-xs font-semibold text-slate-600">Words (this paragraph)</p>
                  <p id="statTotalWords" class="mt-1 text-2xl font-bold">0</p>
                </div>
                <div class="rounded-2xl bg-white p-4 shadow-sm ring-1 ring-slate-200">
                  <p class="text-xs font-semibold text-slate-600">Correct words</p>
                  <p id="statCorrectWords" class="mt-1 text-2xl font-bold">0</p>
                </div>
                <div class="rounded-2xl bg-white p-4 shadow-sm ring-1 ring-slate-200">
                  <p class="text-xs font-semibold text-slate-600">Accuracy</p>
                  <p id="statAccuracy" class="mt-1 text-2xl font-bold">0%</p>
                </div>
              </div>

              <div class="sm:col-span-2 rounded-2xl bg-white p-4 shadow-sm ring-1 ring-slate-200">
                <div class="flex items-center justify-between">
                  <div>
                    <p class="text-xs font-semibold text-slate-600">Accuracy graph</p>
                    <p class="text-sm text-slate-600">This paragraph</p>
                  </div>
                  <span id="graphLabel" class="text-xs font-semibold text-slate-500">0%</span>
                </div>

                <div class="mt-3 flex items-center justify-center">
                  <svg width="140" height="140" viewBox="0 0 120 120" class="select-none">
                    <circle cx="60" cy="60" r="46" fill="none" stroke="#e2e8f0" stroke-width="12" />
                    <circle id="accuracyArc" cx="60" cy="60" r="46" fill="none" stroke="#10b981" stroke-width="12"
                      stroke-linecap="round" stroke-dasharray="0 999" transform="rotate(-90 60 60)" />
                    <text id="accuracyText" x="60" y="64" text-anchor="middle" font-size="22" font-weight="700" fill="#0f172a">0%</text>
                  </svg>
                </div>
              </div>
            </div>

            <div class="mt-4 rounded-2xl bg-white p-4 shadow-sm ring-1 ring-slate-200">
              <div class="flex flex-col gap-3 sm:flex-row sm:items-end sm:justify-between">
                <div>
                  <p class="text-sm font-bold">Download this paragraph report</p>
                  <p class="text-xs text-slate-600">Saves a screenshot of this paragraph report only (PNG/JPG).</p>
                </div>
                <div class="flex flex-col sm:flex-row gap-2 w-full sm:w-auto">
                  <div class="flex-1 sm:flex-none">
                    <label class="text-xs font-semibold text-slate-600" for="downloadFormat">Format</label>
                    <select id="downloadFormat"
                      class="mt-1 w-full sm:w-40 rounded-xl border border-slate-200 bg-white px-3 py-3 text-base shadow-sm focus:outline-none focus:ring-4 focus:ring-slate-200">
                      <option value="png" selected>PNG</option>
                      <option value="jpg">JPG</option>
                    </select>
                  </div>

                  <button id="downloadReport"
                    class="inline-flex items-center justify-center rounded-xl bg-slate-900 px-4 py-3 text-base font-semibold text-white shadow-sm hover:bg-slate-800 active:scale-[0.99] focus:outline-none focus:ring-4 focus:ring-slate-200">
                    Download Screenshot
                  </button>
                </div>
              </div>
              <p id="downloadHint" class="mt-2 text-xs text-slate-500"></p>
            </div>

            <div class="mt-4 rounded-2xl bg-white p-4 sm:p-5 shadow-sm ring-1 ring-slate-200">
              <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
                <div>
                  <p class="text-sm font-bold">Words breakdown</p>
                  <p class="text-xs text-slate-600">
                    Correct (green) and not yet correct (red). Double-click a word for pronunciation + definition.
                  </p>
                </div>
                <div class="inline-flex items-center gap-2 rounded-full bg-slate-50 px-3 py-1 text-xs font-semibold text-slate-700 ring-1 ring-slate-200">
                  <span>Based on best progress so far</span>
                </div>
              </div>

              <div class="mt-4">
                <p class="text-xs font-semibold text-slate-600">Correct</p>
                <div id="correctChips" class="mt-2 flex flex-wrap gap-2"></div>
              </div>

              <div class="mt-4">
                <p class="text-xs font-semibold text-slate-600">Not yet correct</p>
                <div id="incorrectChips" class="mt-2 flex flex-wrap gap-2"></div>
              </div>
            </div>

            <p class="mt-4 text-xs text-slate-500">
              Note: Matching is tolerant and sequential (expects in-order). If a student skips a word, later words may show as “not yet correct.”
            </p>
          </div>
        </div>

        <!-- FULL TEXT + HIGHLIGHT TAB -->
        <div id="textTabPanel" class="hidden">
          <section class="rounded-2xl bg-slate-50 p-4 sm:p-6 ring-1 ring-slate-200">
            <div class="flex flex-col gap-3 sm:flex-row sm:items-end sm:justify-between">
              <div>
                <h2 class="text-lg sm:text-xl font-bold">Full Text & Highlight</h2>
                <p class="mt-1 text-sm text-slate-600">
                  Select words/sentences with your mouse (or long-press and drag on mobile), then click <span class="font-semibold">Highlight</span>.
                  Double-click a word for pronunciation + definition.
                </p>
              </div>

              <div class="flex flex-col sm:flex-row gap-2 w-full sm:w-auto">
                <div class="flex-1 sm:flex-none">
                  <label class="text-xs font-semibold text-slate-600">Highlight color</label>
                  <div class="mt-1 flex flex-wrap gap-2" id="colorPalette"></div>
                </div>
                <div class="flex gap-2">
                  <button id="applyHighlight"
                    class="inline-flex items-center justify-center rounded-xl bg-slate-900 px-4 py-3 text-base font-semibold text-white shadow-sm hover:bg-slate-800 active:scale-[0.99] focus:outline-none focus:ring-4 focus:ring-slate-200">
                    Highlight
                  </button>
                  <button id="clearHighlights"
                    class="inline-flex items-center justify-center rounded-xl bg-white px-4 py-3 text-base font-semibold text-slate-900 shadow-sm ring-1 ring-slate-200 hover:bg-slate-50 active:scale-[0.99] focus:outline-none focus:ring-4 focus:ring-slate-200">
                    Clear highlights
                  </button>
                </div>
              </div>
            </div>

            <div class="mt-5 rounded-2xl bg-white p-4 sm:p-6 shadow-sm ring-1 ring-slate-200">
              <p class="text-xs font-semibold text-slate-500 mb-2">Tip</p>
              <ul class="list-disc pl-5 text-sm text-slate-600 space-y-1">
                <li><span class="font-semibold">Highlight:</span> select text then click Highlight.</li>
                <li><span class="font-semibold">Word help:</span> double-click a word for pronunciation + definition.</li>
              </ul>
            </div>

            <div id="fullTextContainer" class="mt-5 rounded-2xl bg-white p-4 sm:p-6 shadow-sm ring-1 ring-slate-200"></div>
          </section>

          <p class="mt-3 text-xs text-slate-500">
            Definitions are fetched from a public dictionary endpoint. Only the selected word is sent to retrieve the meaning.
          </p>
        </div>

      </div>
    </main>
  </div>

  <!-- Pronunciation + Definition Bubble -->
  <div id="pronounceBubble" class="hidden fixed z-50 max-w-[92vw] sm:max-w-md">
    <div class="rounded-2xl bg-white shadow-lg ring-1 ring-slate-200 p-4">
      <div class="flex items-start justify-between gap-3">
        <div class="min-w-0">
          <p class="text-xs font-semibold text-slate-500">Word help</p>
          <p id="pbWord" class="mt-1 text-xl font-bold text-slate-900 break-words"></p>
          <p id="pbLang" class="mt-1 text-xs text-slate-500"></p>
        </div>
        <button id="pbClose" class="shrink-0 rounded-xl bg-slate-50 px-3 py-2 text-sm font-semibold text-slate-700 ring-1 ring-slate-200 hover:bg-slate-100">
          Close
        </button>
      </div>

      <div class="mt-3 grid grid-cols-2 sm:grid-cols-4 gap-2">
        <button id="pbPlay"
          class="inline-flex items-center justify-center rounded-xl bg-slate-900 px-3 py-3 text-sm font-semibold text-white shadow-sm hover:bg-slate-800 active:scale-[0.99] focus:outline-none focus:ring-4 focus:ring-slate-200">
          Play
        </button>
        <button id="pbSlow"
          class="inline-flex items-center justify-center rounded-xl bg-white px-3 py-3 text-sm font-semibold text-slate-900 shadow-sm ring-1 ring-slate-200 hover:bg-slate-50 active:scale-[0.99] focus:outline-none focus:ring-4 focus:ring-slate-200">
          Slow
        </button>
        <button id="pbRepeat"
          class="inline-flex items-center justify-center rounded-xl bg-white px-3 py-3 text-sm font-semibold text-slate-900 shadow-sm ring-1 ring-slate-200 hover:bg-slate-50 active:scale-[0.99] focus:outline-none focus:ring-4 focus:ring-slate-200">
          Repeat ×2
        </button>
        <button id="pbStop"
          class="inline-flex items-center justify-center rounded-xl bg-white px-3 py-3 text-sm font-semibold text-slate-900 shadow-sm ring-1 ring-slate-200 hover:bg-slate-50 active:scale-[0.99] focus:outline-none focus:ring-4 focus:ring-slate-200">
          Stop
        </button>
      </div>

      <div class="mt-4 rounded-2xl bg-slate-50 p-3 ring-1 ring-slate-200">
        <p class="text-xs font-semibold text-slate-600">Definition</p>
        <div id="pbDef" class="mt-2 text-sm text-slate-700">
          <span class="text-slate-400">Double-click a word to load its definition.</span>
        </div>
      </div>

      <p class="mt-3 text-xs text-slate-500">
        Tip: Listen, repeat, then try reading it again.
      </p>
    </div>
  </div>

  <!-- html2canvas for DOM -> image capture (client-side only) -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<script>
(() => {
  // ---------------------------
  // Fixed Content
  // ---------------------------
  const CONTENT = {
    title: 'THE WANDERER',
    author: 'Sharon Creech',
    context: 'The main character, Sophie, is an orphan adopted by uncles. She is sailing across the Atlantic with her cousins.',
    paragraphs: [
      "I am not always such a dreamy girl, listening to the sea calling me. My father calls me Three-sided Sophie: one side is dreamy and romantic; one is logical and down-to-earth; and the third side is hardheaded and impulsive. He says I am either in dreamland or earthland or mule-land, and if I ever get the three together, I'll be all set, though I wonder where I will be then. If I'm not in dreamland or earthland or mule-land, where will I be?",
      "My father says my logical side is most like him, and the dreamy side most like my mother, which isn't entirely fair, I don't think. My father likes to think of himself as a logical man, but he is the one who pores over pictures of exotic lands and says things like \"We should go on a safari!\" and \"We should zip through the air in a hot-air balloon!\"",
      "And although my mother is a weaver and spins silky cloths and wears flowing dresses, she is the one who gives me sailing textbooks and makes me study water safety and weather prediction and says things like \"Yes, Sophie, I taught you to sail, but that doesn't mean I like the idea of you being out there alone on the water. I want you to stay home. Here. With me. Safe.\"",
      "My father says he doesn't know who my hardheaded mule side resembles. He says mules don't run in the family. I am thirteen, and I am going to sail across the ocean. Although I would like to go alone-alone! alone! flying over the water!-I'm not.",
      "My mule-self begged a place aboard a forty-five-foot sailboat with a motley crew: three uncles and two cousins. The uncles-Stew, Mo, and Dock-are my mother's brothers, and she told them, \"If the slightest harm comes to my Sophie, I'll string you all up by your toes.\""
    ]
  };

  // ---------------------------
  // DOM
  // ---------------------------
  const $ = (id) => document.getElementById(id);

  const titleEl = $('title');
  const contextEl = $('context');
  const paragraphDisplay = $('paragraphDisplay');
  const transcriptBox = $('transcriptBox');

  const studentNameInput = $('studentName');
  const nameError = $('nameError');
  const reportStudent = $('reportStudent');
  const reportPara = $('reportPara');
  const reportParaTotal = $('reportParaTotal');

  const micBtn = $('micBtn');
  const prevBtn = $('prevBtn');
  const nextBtn = $('nextBtn');
  const restartBtn = $('restartBtn');
  const clearTranscriptBtn = $('clearTranscript');
  const langSelect = $('langSelect');

  const statusText = $('statusText');
  const statusDot = $('statusDot');
  const unsupported = $('unsupported');

  const paraIdxEl = $('paraIdx');
  const paraTotalEl = $('paraTotal');

  // Tabs + report
  const tabReadBtn = $('tabRead');
  const tabReportBtn = $('tabReport');
  const tabTextBtn = $('tabText');
  const readTab = $('readTab');
  const reportTabPanel = $('reportTabPanel');
  const textTabPanel = $('textTabPanel');

  const refreshReportBtn = $('refreshReport');
  const resetThisParaBtn = $('resetThisPara');
  const statTotalWords = $('statTotalWords');
  const statCorrectWords = $('statCorrectWords');
  const statAccuracy = $('statAccuracy');

  const correctChipsEl = $('correctChips');
  const incorrectChipsEl = $('incorrectChips');

  // Graph elements
  const graphLabel = $('graphLabel');
  const accuracyArc = $('accuracyArc');
  const accuracyText = $('accuracyText');

  // Download
  const reportCapture = $('reportCapture');
  const downloadReportBtn = $('downloadReport');
  const downloadFormat = $('downloadFormat');
  const downloadHint = $('downloadHint');

  // Full text highlight
  const fullTextContainer = $('fullTextContainer');
  const colorPalette = $('colorPalette');
  const applyHighlightBtn = $('applyHighlight');
  const clearHighlightsBtn = $('clearHighlights');

  // Pronunciation + definition bubble
  const pronounceBubble = $('pronounceBubble');
  const pbWord = $('pbWord');
  const pbLang = $('pbLang');
  const pbClose = $('pbClose');
  const pbPlay = $('pbPlay');
  const pbSlow = $('pbSlow');
  const pbRepeat = $('pbRepeat');
  const pbStop = $('pbStop');
  const pbDef = $('pbDef');

  // ---------------------------
  // Web Speech Support
  // ---------------------------
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  const isSupported = !!SpeechRecognition;

  if (!isSupported) {
    unsupported.classList.remove('hidden');
    [
      studentNameInput, micBtn, prevBtn, nextBtn, restartBtn, langSelect, clearTranscriptBtn,
      tabReadBtn, tabReportBtn, tabTextBtn,
      refreshReportBtn, resetThisParaBtn,
      downloadReportBtn, downloadFormat,
      applyHighlightBtn, clearHighlightsBtn
    ].forEach(el => {
      el.disabled = true;
      el.classList.add('opacity-50', 'cursor-not-allowed');
    });
  }

  // ---------------------------
  // State
  // ---------------------------
  let studentName = '';
  let paragraphIndex = 0;
  let listening = false;

  let spanWords = []; // current paragraph word spans

  // Accumulate across stop/resume (pause)
  let accumulatedFinalText = '';
  let interimText = '';
  let finalMatchedCount = 0;
  let combinedMatchedCount = 0;

  let progress = [];        // per paragraph best
  let paragraphTokens = []; // token cache for report

  let recognition = null;

  // Speech synthesis
  let voices = [];
  let currentPronounceWord = '';

  // Highlighting
  const HIGHLIGHT_COLORS = [
    { name: 'Yellow', bg: '#FEF08A' },
    { name: 'Green',  bg: '#BBF7D0' },
    { name: 'Blue',   bg: '#BFDBFE' },
    { name: 'Pink',   bg: '#FBCFE8' },
    { name: 'Purple', bg: '#DDD6FE' },
    { name: 'Orange', bg: '#FED7AA' },
  ];
  let selectedHighlight = HIGHLIGHT_COLORS[0].bg;

  // ---------------------------
  // Helpers
  // ---------------------------
  const normalizeWord = (w) => (w || '')
    .toLowerCase()
    .replace(/['’]/g, '')
    .replace(/[^a-z0-9]+/g, '')
    .trim();

  const cleanWordForPlayback = (w) => {
    const s = (w || '').trim();
    const stripped = s.replace(/^[^A-Za-z0-9']+|[^A-Za-z0-9']+$/g, '');
    return stripped || s;
  };

  const tokenize = (text) => (text || '')
    .replace(/\s+/g, ' ')
    .trim()
    .split(' ')
    .map(normalizeWord)
    .filter(Boolean);

  const computeMatchedCount = (heardTokens, targetTokens) => {
    let i = 0;
    for (const t of heardTokens) {
      if (i >= targetTokens.length) break;
      if (!t) continue;
      if (t === targetTokens[i]) i++;
    }
    return i;
  };

  const setStatus = (label, dotColor) => {
    statusText.textContent = label;
    statusDot.style.background = dotColor;
  };

  const setTranscript = (finalText, interimText) => {
    const f = (finalText || '').trim();
    const it = (interimText || '').trim();

    if (!f && !it) {
      transcriptBox.innerHTML = '<span class="text-slate-400">(interim results will appear here)</span>';
      return;
    }

    transcriptBox.innerHTML = '';
    if (f) {
      const fSpan = document.createElement('span');
      fSpan.textContent = f;
      transcriptBox.appendChild(fSpan);
    }
    if (it) {
      if (f) transcriptBox.appendChild(document.createTextNode(' '));
      const iSpan = document.createElement('span');
      iSpan.textContent = it;
      iSpan.className = 'italic text-slate-500';
      transcriptBox.appendChild(iSpan);
    }
  };

  const clearRecognitionBufferUI = () => {
    accumulatedFinalText = '';
    interimText = '';
    finalMatchedCount = 0;
    combinedMatchedCount = 0;
    setTranscript('', '');
    renderHighlights();
  };

  const buildTokensAndProgress = () => {
    paragraphTokens = CONTENT.paragraphs.map(p => {
      const raw = (p || '').replace(/\s+/g, ' ').trim().split(' ').filter(Boolean);
      return raw.map(tok => ({ original: tok, norm: normalizeWord(tok) })).filter(t => t.norm);
    });
    progress = CONTENT.paragraphs.map(() => ({ bestFinalCount: 0, bestCombinedCount: 0 }));
  };

  const setAccuracyGraph = (accuracyPct) => {
    const pct = Math.max(0, Math.min(100, Math.round(accuracyPct)));
    const r = 46;
    const c = 2 * Math.PI * r;
    const dash = (pct / 100) * c;

    accuracyArc.setAttribute('stroke-dasharray', `${dash} ${Math.max(0, c - dash)}`);
    accuracyText.textContent = `${pct}%`;
    graphLabel.textContent = `${pct}%`;
  };

  const sanitizeFilenamePart = (s) => (s || 'student')
    .trim()
    .toLowerCase()
    .replace(/\s+/g, '_')
    .replace(/[^a-z0-9_\-]/g, '')
    .slice(0, 40) || 'student';

  const escapeHtml = (s) => (s || '').replace(/[&<>"']/g, (c) => ({
    '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
  }[c]));

  // ---------------------------
  // Mandatory name logic
  // ---------------------------
  const validateName = () => {
    studentName = (studentNameInput.value || '').trim();
    const ok = studentName.length > 0;

    nameError.classList.toggle('hidden', ok);
    studentNameInput.classList.toggle('border-rose-300', !ok);
    studentNameInput.classList.toggle('ring-rose-200', !ok);

    if (isSupported) {
      micBtn.disabled = !ok;
      micBtn.classList.toggle('opacity-50', !ok);
      micBtn.classList.toggle('cursor-not-allowed', !ok);
    }

    reportStudent.textContent = ok ? studentName : '—';
    return ok;
  };

  const requireNameOrFocus = () => {
    const ok = validateName();
    if (!ok) {
      setStatus('Please enter your name', '#ef4444');
      studentNameInput.focus();
      studentNameInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
    return ok;
  };

  // ---------------------------
  // Speech synthesis + bubble + definition
  // ---------------------------
  const loadVoices = () => {
    voices = window.speechSynthesis ? window.speechSynthesis.getVoices() : [];
  };

  const pickVoiceForLang = (lang) => {
    if (!voices || voices.length === 0) return null;
    const exact = voices.find(v => (v.lang || '').toLowerCase() === (lang || '').toLowerCase());
    if (exact) return exact;
    const prefix = voices.find(v => (v.lang || '').toLowerCase().startsWith((lang || '').toLowerCase().slice(0,2)));
    if (prefix) return prefix;
    const english = voices.find(v => (v.lang || '').toLowerCase().startsWith('en'));
    return english || null;
  };

  const speakWord = (word, rate = 1) => {
    if (!window.speechSynthesis) return;
    const w = cleanWordForPlayback(word);
    if (!w) return;

    window.speechSynthesis.cancel();

    const utter = new SpeechSynthesisUtterance(w);
    const lang = langSelect.value || 'en-US';
    utter.lang = lang;
    utter.rate = rate;

    const voice = pickVoiceForLang(lang);
    if (voice) utter.voice = voice;

    window.speechSynthesis.speak(utter);
  };

  const stopSpeech = () => {
    if (!window.speechSynthesis) return;
    window.speechSynthesis.cancel();
  };

  const positionBubbleNearElement = (el) => {
    const rect = el.getBoundingClientRect();
    const bubbleRect = pronounceBubble.getBoundingClientRect();

    const margin = 10;
    let top = rect.bottom + margin;
    let left = rect.left;

    const maxLeft = window.innerWidth - bubbleRect.width - margin;
    left = Math.max(margin, Math.min(left, maxLeft));

    if (top + bubbleRect.height + margin > window.innerHeight) {
      top = rect.top - bubbleRect.height - margin;
      if (top < margin) top = margin;
    }

    pronounceBubble.style.top = `${Math.round(top)}px`;
    pronounceBubble.style.left = `${Math.round(left)}px`;
  };

  const fetchDefinition = async (word) => {
    const w = normalizeWord(word);
    if (!w) return;

    pbDef.innerHTML = `<span class="text-slate-400">Loading definition…</span>`;

    try {
      const res = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${encodeURIComponent(w)}`);
      if (!res.ok) throw new Error('not ok');
      const data = await res.json();

      const entry = Array.isArray(data) ? data[0] : null;
      const meanings = entry?.meanings || [];
      const defs = [];

      for (const m of meanings.slice(0, 2)) {
        const part = m.partOfSpeech || '';
        const d = m.definitions?.[0]?.definition || '';
        if (d) defs.push({ part, d });
      }

      if (defs.length === 0) {
        pbDef.innerHTML = `<span class="text-slate-500">No definition found.</span>`;
        return;
      }

      pbDef.innerHTML = defs.map(x => `
        <div class="mb-2">
          <div class="text-xs font-semibold text-slate-600">${escapeHtml(x.part || 'definition')}</div>
          <div class="text-sm text-slate-800">${escapeHtml(x.d)}</div>
        </div>
      `).join('');
    } catch (e) {
      pbDef.innerHTML = `<span class="text-slate-500">Could not load definition (offline or blocked).</span>`;
    }
  };

  const openWordHelpBubble = (anchorEl, word, autoSpeak = true) => {
    currentPronounceWord = cleanWordForPlayback(word);
    if (!currentPronounceWord) return;

    pbWord.textContent = currentPronounceWord;
    pbLang.textContent = `Pronunciation voice: ${langSelect.value || 'en-US'} (device/browser voices)`;
    pbDef.innerHTML = `<span class="text-slate-400">Loading definition…</span>`;

    pronounceBubble.classList.remove('hidden');

    requestAnimationFrame(() => {
      positionBubbleNearElement(anchorEl);
      if (autoSpeak) speakWord(currentPronounceWord, 1);
      fetchDefinition(currentPronounceWord);
    });
  };

  const closePronounceBubble = () => {
    pronounceBubble.classList.add('hidden');
    currentPronounceWord = '';
    stopSpeech();
  };

  // ✅ ONLY double-click opens the bubble now (no single click / no long-press)
  const addWordHelpEvents = (el, getWordFn) => {
    el.addEventListener('dblclick', (e) => {
      e.preventDefault();
      e.stopPropagation();
      openWordHelpBubble(el, getWordFn(), true);
    });
  };

  pbClose.addEventListener('click', closePronounceBubble);
  pbPlay.addEventListener('click', () => speakWord(currentPronounceWord, 1));
  pbSlow.addEventListener('click', () => speakWord(currentPronounceWord, 0.8));
  pbRepeat.addEventListener('click', () => {
    if (!currentPronounceWord) return;
    stopSpeech();
    speakWord(currentPronounceWord, 1);
    setTimeout(() => speakWord(currentPronounceWord, 1), 850);
  });
  pbStop.addEventListener('click', stopSpeech);

  document.addEventListener('click', (e) => {
    if (pronounceBubble.classList.contains('hidden')) return;
    if (pronounceBubble.contains(e.target)) return;
    closePronounceBubble();
  });

  window.addEventListener('scroll', () => {
    if (!pronounceBubble.classList.contains('hidden')) closePronounceBubble();
  }, { passive: true });

  // ---------------------------
  // Tabs
  // ---------------------------
  const setActiveTab = (tab) => {
    const isRead = tab === 'read';
    const isReport = tab === 'report';
    const isText = tab === 'text';

    readTab.classList.toggle('hidden', !isRead);
    reportTabPanel.classList.toggle('hidden', !isReport);
    textTabPanel.classList.toggle('hidden', !isText);

    const active = 'bg-slate-900 text-white ring-slate-900';
    const inactive = 'bg-white text-slate-900 ring-slate-200 hover:bg-slate-50';

    tabReadBtn.className = `inline-flex items-center justify-center rounded-xl px-4 py-3 text-base font-semibold shadow-sm ring-1 focus:outline-none focus:ring-4 focus:ring-slate-200 ${isRead ? active : inactive}`;
    tabReportBtn.className = `inline-flex items-center justify-center rounded-xl px-4 py-3 text-base font-semibold shadow-sm ring-1 focus:outline-none focus:ring-4 focus:ring-slate-200 ${isReport ? active : inactive}`;
    tabTextBtn.className = `inline-flex items-center justify-center rounded-xl px-4 py-3 text-base font-semibold shadow-sm ring-1 focus:outline-none focus:ring-4 focus:ring-slate-200 ${isText ? active : inactive}`;

    if (isReport) renderParagraphReport();
  };

  // ---------------------------
  // Rendering: header + read-along paragraph
  // ---------------------------
  const renderHeader = () => {
    titleEl.innerHTML = `${escapeHtml(CONTENT.title)} <span class="text-slate-500 font-semibold">by ${escapeHtml(CONTENT.author || '')}</span>`;
    contextEl.textContent = CONTENT.context || '';
    paraTotalEl.textContent = String(CONTENT.paragraphs.length);
    reportParaTotal.textContent = String(CONTENT.paragraphs.length);
  };

  const renderParagraph = () => {
    const paragraph = CONTENT.paragraphs[paragraphIndex] || '';
    const rawTokens = paragraph.replace(/\s+/g, ' ').trim().split(' ').filter(Boolean);

    spanWords = rawTokens.map((tok) => {
      const span = document.createElement('span');
      span.textContent = tok;
      span.className = 'transition-colors duration-200 cursor-pointer select-none';
      // Word help: double-click only
      addWordHelpEvents(span, () => tok);
      return { original: tok, norm: normalizeWord(tok), el: span };
    });

    paragraphDisplay.innerHTML = '';
    spanWords.forEach((w, idx) => {
      paragraphDisplay.appendChild(w.el);
      if (idx < spanWords.length - 1) paragraphDisplay.appendChild(document.createTextNode(' '));
    });

    paraIdxEl.textContent = String(paragraphIndex + 1);

    clearRecognitionBufferUI();

    prevBtn.disabled = paragraphIndex === 0;
    nextBtn.disabled = paragraphIndex === CONTENT.paragraphs.length - 1;

    [prevBtn, nextBtn].forEach(btn => {
      btn.classList.toggle('opacity-50', btn.disabled);
      btn.classList.toggle('cursor-not-allowed', btn.disabled);
    });

    if (!reportTabPanel.classList.contains('hidden')) renderParagraphReport();
  };

  const renderHighlights = () => {
    const targetTokens = spanWords.map(w => w.norm).filter(Boolean);
    const finalCount = Math.min(finalMatchedCount, targetTokens.length);
    const combinedCount = Math.min(combinedMatchedCount, targetTokens.length);

    let normalizedIndex = 0;

    for (const w of spanWords) {
      if (!w.norm) {
        w.el.className = 'transition-colors duration-200 text-slate-900 cursor-pointer select-none';
        continue;
      }

      const idx = normalizedIndex;

      if (idx < finalCount) {
        w.el.className = 'transition-colors duration-200 font-semibold text-emerald-700 cursor-pointer select-none';
      } else if (idx < combinedCount) {
        w.el.className = 'transition-colors duration-200 font-semibold text-emerald-500 cursor-pointer select-none';
      } else if (idx === combinedCount) {
        w.el.className = 'transition-colors duration-200 text-slate-900 underline decoration-amber-400 decoration-4 underline-offset-4 cursor-pointer select-none';
      } else {
        w.el.className = 'transition-colors duration-200 text-slate-900 cursor-pointer select-none';
      }

      normalizedIndex++;
    }
  };

  // ---------------------------
  // Paragraph report (current paragraph only)
  // ---------------------------
  const makeChip = (t, type) => {
    const chip = document.createElement('span');
    chip.className =
      type === 'correct'
        ? 'rounded-full bg-emerald-50 px-3 py-1 text-sm font-semibold text-emerald-700 ring-1 ring-emerald-200 cursor-pointer select-none'
        : 'rounded-full bg-rose-50 px-3 py-1 text-sm font-semibold text-rose-700 ring-1 ring-rose-200 cursor-pointer select-none';
    chip.textContent = t.original;

    // Word help: double-click only
    addWordHelpEvents(chip, () => t.original);

    return chip;
  };

  const renderParagraphReport = () => {
    validateName();

    const tokens = paragraphTokens[paragraphIndex] || [];
    const best = Math.min(progress[paragraphIndex]?.bestFinalCount || 0, tokens.length);
    const pct = tokens.length ? Math.round((best / tokens.length) * 100) : 0;

    reportPara.textContent = String(paragraphIndex + 1);

    statTotalWords.textContent = String(tokens.length);
    statCorrectWords.textContent = String(best);
    statAccuracy.textContent = `${pct}%`;
    setAccuracyGraph(pct);

    correctChipsEl.innerHTML = '';
    incorrectChipsEl.innerHTML = '';

    const correctTokens = tokens.slice(0, best);
    const incorrectTokens = tokens.slice(best);

    if (correctTokens.length === 0) {
      const empty = document.createElement('span');
      empty.className = 'text-sm text-slate-400';
      empty.textContent = '(none yet)';
      correctChipsEl.appendChild(empty);
    } else {
      correctTokens.forEach(t => correctChipsEl.appendChild(makeChip(t, 'correct')));
    }

    if (incorrectTokens.length === 0) {
      const empty = document.createElement('span');
      empty.className = 'text-sm text-slate-400';
      empty.textContent = '(all words correct!)';
      incorrectChipsEl.appendChild(empty);
    } else {
      incorrectTokens.forEach(t => incorrectChipsEl.appendChild(makeChip(t, 'incorrect')));
    }
  };

  // ---------------------------
  // Full Text + Highlight (selection-based)
  // ---------------------------
  const renderColorPalette = () => {
    colorPalette.innerHTML = '';
    HIGHLIGHT_COLORS.forEach((c) => {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'inline-flex items-center gap-2 rounded-xl bg-white px-3 py-2 text-sm font-semibold text-slate-900 shadow-sm ring-1 ring-slate-200 hover:bg-slate-50 focus:outline-none focus:ring-4 focus:ring-slate-200';
      btn.innerHTML = `
        <span class="h-4 w-4 rounded-md ring-1 ring-slate-200" style="background:${c.bg}"></span>
        <span>${c.name}</span>
      `;
      const markSelected = () => {
        [...colorPalette.children].forEach(x => x.classList.remove('ring-2', 'ring-slate-900'));
        btn.classList.add('ring-2', 'ring-slate-900');
      };
      btn.addEventListener('click', () => {
        selectedHighlight = c.bg;
        markSelected();
      });
      colorPalette.appendChild(btn);
      if (c.bg === selectedHighlight) markSelected();
    });
  };

  const buildFullTextDOM = () => {
    fullTextContainer.innerHTML = '';

    const t = document.createElement('div');
    t.className = 'mb-4';
    t.innerHTML = `
      <div class="text-xl sm:text-2xl font-bold">${escapeHtml(CONTENT.title)}
        <span class="text-slate-500 font-semibold">by ${escapeHtml(CONTENT.author)}</span>
      </div>
      <div class="mt-1 text-sm italic text-slate-600">${escapeHtml(CONTENT.context)}</div>
    `;
    fullTextContainer.appendChild(t);

    CONTENT.paragraphs.forEach((p, idx) => {
      const block = document.createElement('div');
      block.className = 'mb-4 last:mb-0';

      const label = document.createElement('div');
      label.className = 'text-xs font-semibold text-slate-500 mb-1';
      label.textContent = `Paragraph ${idx + 1}`;
      block.appendChild(label);

      const para = document.createElement('p');
      para.className = 'text-lg leading-relaxed text-slate-900';

      const rawTokens = p.replace(/\s+/g, ' ').trim().split(' ').filter(Boolean);
      rawTokens.forEach((tok, i) => {
        const span = document.createElement('span');
        span.textContent = tok;
        span.className = 'cursor-pointer select-text';
        // Word help: double-click only
        addWordHelpEvents(span, () => tok);

        para.appendChild(span);
        if (i < rawTokens.length - 1) para.appendChild(document.createTextNode(' '));
      });

      block.appendChild(para);
      fullTextContainer.appendChild(block);
    });
  };

  const selectionIsInside = (sel, container) => {
    if (!sel || sel.rangeCount === 0) return false;
    const range = sel.getRangeAt(0);
    return container.contains(range.commonAncestorContainer);
  };

  const applyHighlightToSelection = () => {
    const sel = window.getSelection();
    if (!sel || sel.rangeCount === 0) return;

    if (!selectionIsInside(sel, fullTextContainer)) {
      setStatus('Select text inside Full Text tab', '#f59e0b');
      return;
    }

    const range = sel.getRangeAt(0);
    if (range.collapsed) {
      setStatus('Select some text first', '#f59e0b');
      return;
    }

    const mark = document.createElement('mark');
    mark.className = 'rounded-md px-0.5';
    mark.style.background = selectedHighlight;
    mark.style.color = '#0f172a';

    try {
      range.surroundContents(mark);
    } catch (e) {
      const frag = range.extractContents();
      mark.appendChild(frag);
      range.insertNode(mark);
    }

    sel.removeAllRanges();
    setStatus('Highlighted', '#94a3b8');
  };

  const clearAllHighlights = () => {
    const marks = fullTextContainer.querySelectorAll('mark');
    marks.forEach((m) => {
      const parent = m.parentNode;
      while (m.firstChild) parent.insertBefore(m.firstChild, m);
      parent.removeChild(m);
      parent.normalize();
    });
    setStatus('Highlights cleared', '#94a3b8');
  };

  // ---------------------------
  // Recognition lifecycle
  // ---------------------------
  const initRecognition = () => {
    if (!isSupported) return;

    recognition = new SpeechRecognition();
    recognition.lang = langSelect.value || 'en-US';
    recognition.continuous = true;
    recognition.interimResults = true;
    recognition.maxAlternatives = 1;

    recognition.onstart = () => {
      listening = true;
      micBtn.textContent = 'Stop';
      setStatus('Listening...', '#10b981');
    };

    recognition.onend = () => {
      listening = false;
      micBtn.textContent = 'Start Reading';
      setStatus('Paused', '#94a3b8');
    };

    recognition.onerror = (e) => {
      if (e.error === 'not-allowed' || e.error === 'service-not-allowed') {
        setStatus('Microphone access denied', '#ef4444');
      } else if (e.error === 'no-speech') {
        setStatus('No speech detected', '#f59e0b');
      } else {
        setStatus(`Error: ${e.error}`, '#ef4444');
      }
    };

    recognition.onresult = (event) => {
      let newInterim = '';

      for (let i = event.resultIndex; i < event.results.length; i++) {
        const res = event.results[i];
        const text = res[0].transcript;
        if (res.isFinal) accumulatedFinalText += (text + ' ');
        else newInterim += (text + ' ');
      }

      accumulatedFinalText = accumulatedFinalText.replace(/\s+/g, ' ').trim();
      interimText = newInterim.replace(/\s+/g, ' ').trim();

      setTranscript(accumulatedFinalText, interimText);

      const targetTokens = spanWords.map(w => w.norm).filter(Boolean);
      finalMatchedCount = computeMatchedCount(tokenize(accumulatedFinalText), targetTokens);
      combinedMatchedCount = computeMatchedCount(tokenize((accumulatedFinalText + ' ' + interimText).trim()), targetTokens);

      const tLen = paragraphTokens[paragraphIndex]?.length || targetTokens.length;
      const cur = progress[paragraphIndex];
      if (cur) {
        cur.bestFinalCount = Math.min(Math.max(cur.bestFinalCount, finalMatchedCount), tLen);
        cur.bestCombinedCount = Math.min(Math.max(cur.bestCombinedCount, combinedMatchedCount), tLen);
      }

      renderHighlights();

      if (!reportTabPanel.classList.contains('hidden')) {
        renderParagraphReport();
      }
    };
  };

  const startListening = () => {
    if (!isSupported) return;
    if (!recognition) initRecognition();
    try { recognition.start(); } catch (_) {}
  };

  const stopListening = () => {
    if (!isSupported || !recognition) return;
    try { recognition.stop(); } catch (_) {}
  };

  const resetEngineKeepBuffers = (resume) => {
    if (!isSupported) return;
    const shouldResume = !!resume;

    try { recognition && recognition.abort(); } catch (_) {}
    recognition = null;
    initRecognition();

    setTranscript(accumulatedFinalText, interimText);
    renderHighlights();

    if (shouldResume) setTimeout(() => startListening(), 120);
  };

  const hardResetForParagraphChange = (resume) => {
    const shouldResume = !!resume;

    try { recognition && recognition.abort(); } catch (_) {}
    recognition = null;
    initRecognition();

    clearRecognitionBufferUI();

    if (shouldResume) setTimeout(() => startListening(), 120);
  };

  // ---------------------------
  // Navigation
  // ---------------------------
  const goToParagraph = (idx) => {
    const clamped = Math.max(0, Math.min(idx, CONTENT.paragraphs.length - 1));
    if (clamped === paragraphIndex) return;

    const wasListening = listening;
    if (wasListening) stopListening();

    paragraphIndex = clamped;
    renderParagraph();

    hardResetForParagraphChange(wasListening);
  };

  const restartParagraph = () => {
    const wasListening = listening;
    if (wasListening) stopListening();

    hardResetForParagraphChange(wasListening);
  };

  // ---------------------------
  // Screenshot Download (current paragraph report)
  // ---------------------------
  const pad2 = (n) => String(n).padStart(2, '0');
  const makeTimestamp = () => {
    const d = new Date();
    return `${d.getFullYear()}${pad2(d.getMonth()+1)}${pad2(d.getDate())}-${pad2(d.getHours())}${pad2(d.getMinutes())}${pad2(d.getSeconds())}`;
  };

  const downloadDataUrl = (dataUrl, filename) => {
    const a = document.createElement('a');
    a.href = dataUrl;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
  };

  const captureReportAndDownload = async () => {
    if (!requireNameOrFocus()) return;

    renderParagraphReport();

    const format = (downloadFormat.value || 'png').toLowerCase();
    const isJpg = format === 'jpg' || format === 'jpeg';

    try {
      downloadHint.textContent = 'Creating image…';

      const canvas = await html2canvas(reportCapture, {
        backgroundColor: '#f8fafc',
        scale: 2,
        useCORS: true
      });

      const who = sanitizeFilenamePart(studentName);
      const stamp = makeTimestamp();
      const p = `p${paragraphIndex + 1}`;

      if (isJpg) {
        const dataUrl = canvas.toDataURL('image/jpeg', 0.92);
        downloadDataUrl(dataUrl, `read-along_${who}_${p}_${stamp}.jpg`);
      } else {
        const dataUrl = canvas.toDataURL('image/png');
        downloadDataUrl(dataUrl, `read-along_${who}_${p}_${stamp}.png`);
      }

      downloadHint.textContent = 'Downloaded.';
      setTimeout(() => (downloadHint.textContent = ''), 2000);
    } catch (err) {
      console.error(err);
      downloadHint.textContent = 'Could not create image (try Chrome/Edge).';
      setTimeout(() => (downloadHint.textContent = ''), 4000);
    }
  };

  // ---------------------------
  // Events
  // ---------------------------
  studentNameInput.addEventListener('input', () => {
    validateName();
    if (studentNameInput.value.trim().length > 0) setStatus('Paused', '#94a3b8');
  });

  studentNameInput.addEventListener('blur', validateName);

  micBtn.addEventListener('click', () => {
    if (!isSupported) return;
    if (!requireNameOrFocus()) return;

    if (!recognition) initRecognition();

    if (!listening) startListening();
    else stopListening();
  });

  prevBtn.addEventListener('click', () => goToParagraph(paragraphIndex - 1));
  nextBtn.addEventListener('click', () => goToParagraph(paragraphIndex + 1));
  restartBtn.addEventListener('click', restartParagraph);

  clearTranscriptBtn.addEventListener('click', () => {
    const wasListening = listening;
    if (wasListening) stopListening();

    clearRecognitionBufferUI();
    resetEngineKeepBuffers(false);

    if (wasListening) setTimeout(() => startListening(), 120);
  });

  langSelect.addEventListener('change', () => {
    loadVoices();

    const wasListening = listening;
    if (wasListening) stopListening();

    resetEngineKeepBuffers(false);
    if (wasListening) setTimeout(() => startListening(), 120);

    if (!pronounceBubble.classList.contains('hidden') && currentPronounceWord) {
      pbLang.textContent = `Pronunciation voice: ${langSelect.value || 'en-US'} (device/browser voices)`;
    }
  });

  tabReadBtn.addEventListener('click', () => setActiveTab('read'));
  tabReportBtn.addEventListener('click', () => setActiveTab('report'));
  tabTextBtn.addEventListener('click', () => setActiveTab('text'));

  refreshReportBtn.addEventListener('click', renderParagraphReport);

  resetThisParaBtn.addEventListener('click', () => {
    progress[paragraphIndex].bestFinalCount = 0;
    progress[paragraphIndex].bestCombinedCount = 0;
    renderParagraphReport();
    setStatus('Paragraph result reset', '#94a3b8');
  });

  downloadReportBtn.addEventListener('click', captureReportAndDownload);

  applyHighlightBtn.addEventListener('click', () => applyHighlightToSelection());
  clearHighlightsBtn.addEventListener('click', () => clearAllHighlights());

  // ---------------------------
  // Init
  // ---------------------------
  if (window.speechSynthesis) {
    loadVoices();
    window.speechSynthesis.onvoiceschanged = () => loadVoices();
  }

  buildTokensAndProgress();
  renderHeader();
  renderParagraph();
  renderColorPalette();
  buildFullTextDOM();
  setAccuracyGraph(0);

  setActiveTab('read');

  validateName();
  if (isSupported) {
    initRecognition();
    setStatus('Enter your name to start', '#f59e0b');
  }
})();
</script>
</body>
</html>
