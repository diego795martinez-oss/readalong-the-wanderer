<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Read-Along (EFL) — Web Speech API</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    #pronounceBubble { will-change: transform; }
  </style>
</head>

<body class="min-h-screen bg-slate-50 text-slate-900">
  <div class="mx-auto max-w-4xl px-4 py-6 sm:py-10">

    <!-- Header -->
    <header class="mb-6 sm:mb-8">
      <div class="flex flex-col gap-2 sm:flex-row sm:items-end sm:justify-between">
        <div>
          <h1 id="title" class="text-2xl sm:text-3xl font-bold tracking-tight">
            THE WANDERER <span class="text-slate-500 font-semibold">by Sharon Creech</span>
          </h1>
          <p id="context" class="mt-2 text-sm sm:text-base italic text-slate-600">
            The main character, Sophie, is an orphan adopted by uncles. She is sailing across the Atlantic with her cousins.
          </p>
        </div>

        <div class="flex items-center gap-2">
          <span class="inline-flex items-center gap-2 rounded-full bg-white px-3 py-1 text-xs sm:text-sm shadow-sm ring-1 ring-slate-200">
            <span class="h-2.5 w-2.5 rounded-full" id="statusDot" style="background:#94a3b8"></span>
            <span id="statusText" class="text-slate-700">Paused</span>
          </span>
        </div>
      </div>
    </header>

    <!-- Unsupported Browser Warning -->
    <div id="unsupported" class="hidden mb-6 rounded-xl border border-amber-200 bg-amber-50 p-4 text-amber-900">
      <p class="font-semibold">Browser not supported.</p>
      <p class="mt-1 text-sm">
        Please use Google Chrome or Microsoft Edge (desktop or Android). Some iOS versions and Firefox may not support the Web Speech API.
      </p>
    </div>

    <!-- Main Card -->
    <main class="rounded-2xl bg-white shadow-sm ring-1 ring-slate-200">
      <div class="p-4 sm:p-6">

        <!-- Tabs -->
        <div class="mb-4 flex items-center gap-2">
          <button id="tabRead"
            class="flex-1 sm:flex-none inline-flex items-center justify-center rounded-xl px-4 py-3 text-base font-semibold shadow-sm ring-1 ring-slate-200 focus:outline-none focus:ring-4 focus:ring-slate-200">
            Read Along
          </button>
          <button id="tabReport"
            class="flex-1 sm:flex-none inline-flex items-center justify-center rounded-xl px-4 py-3 text-base font-semibold shadow-sm ring-1 ring-slate-200 focus:outline-none focus:ring-4 focus:ring-slate-200">
            Report
          </button>
        </div>

        <!-- READ TAB -->
        <div id="readTab" class="flex flex-col gap-3 sm:gap-4">
          <!-- Student Name (Mandatory) -->
          <section class="rounded-2xl bg-white p-4 sm:p-6 ring-1 ring-slate-200">
            <div class="flex flex-col gap-2 sm:flex-row sm:items-end sm:justify-between">
              <div class="flex-1">
                <label for="studentName" class="text-sm font-bold text-slate-900">
                  Your name <span class="text-rose-600">*</span>
                </label>
                <p class="text-xs text-slate-600 mt-1">You must enter your name before you can start reading.</p>
                <input id="studentName" type="text" inputmode="text" autocomplete="name"
                  placeholder="Type your full name"
                  class="mt-2 w-full rounded-xl border border-slate-200 bg-white px-3 py-3 text-base shadow-sm focus:outline-none focus:ring-4 focus:ring-slate-200" />
                <p id="nameError" class="hidden mt-2 text-sm font-semibold text-rose-700">Please enter your name.</p>
              </div>
              <div class="sm:pl-4">
                <div class="inline-flex items-center gap-2 rounded-xl bg-slate-50 px-3 py-2 text-xs font-semibold text-slate-700 ring-1 ring-slate-200">
                  Your name will appear on screenshots.
                </div>
              </div>
            </div>
          </section>

          <div class="flex flex-col gap-3 sm:flex-row sm:items-end sm:justify-between">
            <div class="grid grid-cols-2 gap-2 sm:flex sm:gap-3">
              <button id="micBtn"
                class="col-span-2 sm:col-auto inline-flex items-center justify-center rounded-xl bg-slate-900 px-4 py-3 text-base font-semibold text-white shadow-sm hover:bg-slate-800 active:scale-[0.99] focus:outline-none focus:ring-4 focus:ring-slate-200">
                Start Reading
              </button>

              <button id="prevBtn"
                class="inline-flex items-center justify-center rounded-xl bg-white px-4 py-3 text-base font-semibold text-slate-900 shadow-sm ring-1 ring-slate-200 hover:bg-slate-50 active:scale-[0.99] focus:outline-none focus:ring-4 focus:ring-slate-200">
                Previous
              </button>

              <button id="nextBtn"
                class="inline-flex items-center justify-center rounded-xl bg-white px-4 py-3 text-base font-semibold text-slate-900 shadow-sm ring-1 ring-slate-200 hover:bg-slate-50 active:scale-[0.99] focus:outline-none focus:ring-4 focus:ring-slate-200">
                Next
              </button>

              <button id="restartBtn"
                class="col-span-2 sm:col-auto inline-flex items-center justify-center rounded-xl bg-white px-4 py-3 text-base font-semibold text-slate-900 shadow-sm ring-1 ring-slate-200 hover:bg-slate-50 active:scale-[0.99] focus:outline-none focus:ring-4 focus:ring-slate-200">
                Restart Paragraph
              </button>
            </div>

            <div class="flex flex-col gap-2 sm:items-end">
              <label class="text-sm font-medium text-slate-700" for="langSelect">Recognition Accent</label>
              <select id="langSelect"
                class="w-full sm:w-56 rounded-xl border border-slate-200 bg-white px-3 py-3 text-base shadow-sm focus:outline-none focus:ring-4 focus:ring-slate-200">
                <option value="en-US" selected>English (US) — en-US</option>
                <option value="en-GB">English (UK) — en-GB</option>
              </select>
            </div>
          </div>

          <!-- Capture Wrapper (for shorter evidence download) -->
          <div id="readCapture" class="rounded-2xl bg-white ring-1 ring-slate-200">
            <!-- Paragraph Area -->
            <section aria-label="Reading paragraph" class="rounded-2xl bg-slate-50 p-4 sm:p-6">
              <div class="flex flex-col gap-2 sm:flex-row sm:items-start sm:justify-between">
                <div>
                  <p class="text-xs sm:text-sm font-semibold text-slate-600">
                    Student: <span id="readStudent" class="text-slate-900 font-bold">—</span>
                  </p>
                  <p class="text-xs sm:text-sm font-semibold text-slate-600 mt-1">
                    Paragraph <span id="paraIdx">1</span> / <span id="paraTotal">5</span>
                  </p>
                </div>
                <p class="text-xs sm:text-sm text-slate-500" id="hint">
                  Tip: Words turn green as the engine recognizes them. Double-click (or long-press) any word to hear it.
                </p>
              </div>

              <div class="mt-4 text-lg sm:text-xl leading-relaxed text-slate-900" id="paragraphDisplay"></div>

              <div class="mt-5">
                <div class="flex items-center justify-between">
                  <p class="text-xs sm:text-sm font-semibold text-slate-700">Live transcript (what the computer hears)</p>
                  <button id="clearTranscript" class="text-xs sm:text-sm font-semibold text-slate-700 hover:text-slate-900">
                    Clear
                  </button>
                </div>

                <div class="mt-2 rounded-xl bg-white p-3 sm:p-4 text-sm sm:text-base text-slate-700 shadow-sm ring-1 ring-slate-200" id="transcriptBox">
                  <span class="text-slate-400">(interim results will appear here)</span>
                </div>
              </div>
            </section>

            <!-- PARAGRAPH REPORT (now on the same tab) -->
            <section class="p-4 sm:p-6 border-t border-slate-200 bg-white rounded-b-2xl">
              <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
                <div>
                  <h3 class="text-lg font-bold">Paragraph Report</h3>
                  <p class="text-sm text-slate-600">Short evidence for the current paragraph only.</p>
                </div>

                <div class="flex flex-col sm:flex-row gap-2 w-full sm:w-auto">
                  <div class="flex-1 sm:flex-none">
                    <label class="text-xs font-semibold text-slate-600" for="downloadParaFormat">Format</label>
                    <select id="downloadParaFormat"
                      class="mt-1 w-full sm:w-40 rounded-xl border border-slate-200 bg-white px-3 py-3 text-base shadow-sm focus:outline-none focus:ring-4 focus:ring-slate-200">
                      <option value="png" selected>PNG</option>
                      <option value="jpg">JPG</option>
                    </select>
                  </div>

                  <button id="downloadParagraph"
                    class="inline-flex items-center justify-center rounded-xl bg-slate-900 px-4 py-3 text-base font-semibold text-white shadow-sm hover:bg-slate-800 active:scale-[0.99] focus:outline-none focus:ring-4 focus:ring-slate-200">
                    Download Paragraph Evidence
                  </button>
                </div>
              </div>
              <p id="downloadParaHint" class="mt-2 text-xs text-slate-500"></p>

              <div class="mt-4 grid gap-3 sm:grid-cols-5">
                <div class="sm:col-span-3 grid gap-3 sm:grid-cols-3">
                  <div class="rounded-2xl bg-slate-50 p-4 ring-1 ring-slate-200">
                    <p class="text-xs font-semibold text-slate-600">Total words</p>
                    <p id="paraStatTotal" class="mt-1 text-2xl font-bold">0</p>
                  </div>
                  <div class="rounded-2xl bg-slate-50 p-4 ring-1 ring-slate-200">
                    <p class="text-xs font-semibold text-slate-600">Correct words</p>
                    <p id="paraStatCorrect" class="mt-1 text-2xl font-bold">0</p>
                  </div>
                  <div class="rounded-2xl bg-slate-50 p-4 ring-1 ring-slate-200">
                    <p class="text-xs font-semibold text-slate-600">Accuracy</p>
                    <p id="paraStatAccuracy" class="mt-1 text-2xl font-bold">0%</p>
                  </div>
                </div>

                <div class="sm:col-span-2 rounded-2xl bg-slate-50 p-4 ring-1 ring-slate-200">
                  <div class="flex items-center justify-between">
                    <div>
                      <p class="text-xs font-semibold text-slate-600">Accuracy graph</p>
                      <p class="text-sm text-slate-600">This paragraph</p>
                    </div>
                    <span id="paraGraphLabel" class="text-xs font-semibold text-slate-500">0%</span>
                  </div>

                  <div class="mt-3 flex items-center justify-center">
                    <svg width="120" height="120" viewBox="0 0 120 120" class="select-none">
                      <circle cx="60" cy="60" r="46" fill="none" stroke="#e2e8f0" stroke-width="12" />
                      <circle id="paraAccuracyArc" cx="60" cy="60" r="46" fill="none" stroke="#10b981" stroke-width="12"
                        stroke-linecap="round" stroke-dasharray="0 999" transform="rotate(-90 60 60)" />
                      <text id="paraAccuracyText" x="60" y="64" text-anchor="middle" font-size="22" font-weight="700" fill="#0f172a">0%</text>
                    </svg>
                  </div>
                </div>
              </div>

              <div class="mt-4 grid gap-3 sm:grid-cols-2">
                <div class="rounded-2xl bg-white p-4 ring-1 ring-slate-200">
                  <p class="text-xs font-semibold text-slate-600">Correct</p>
                  <div id="paraCorrectChips" class="mt-2 flex flex-wrap gap-2"></div>
                </div>
                <div class="rounded-2xl bg-white p-4 ring-1 ring-slate-200">
                  <p class="text-xs font-semibold text-slate-600">Not yet correct</p>
                  <div id="paraIncorrectChips" class="mt-2 flex flex-wrap gap-2"></div>
                </div>
              </div>

              <p class="mt-4 text-xs text-slate-500">
                Matching is tolerant and sequential (expects in-order). If a word is skipped, later words may show as “not yet correct.”
              </p>
            </section>
          </div>

          <footer class="pt-1 pb-2">
            <p class="text-xs text-slate-500">
              Privacy: Audio is processed locally by your browser using the Web Speech API. Pronunciation playback uses on-device Speech Synthesis. Nothing is stored or uploaded by this page.
            </p>
          </footer>
        </div>

        <!-- REPORT TAB (short: overall summary + choose paragraph, no long list) -->
        <div id="reportTabPanel" class="hidden">
          <div class="rounded-2xl bg-slate-50 p-4 sm:p-6 ring-1 ring-slate-200">
            <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
              <div>
                <h2 class="text-lg sm:text-xl font-bold">Report</h2>
                <p class="text-sm text-slate-600">
                  Student: <span id="reportStudent" class="font-semibold text-slate-900">—</span>
                </p>
                <p class="text-sm text-slate-600 mt-1">Overall summary + quick paragraph view (no long list).</p>
              </div>

              <div class="flex flex-col sm:flex-row gap-2 w-full sm:w-auto">
                <div class="flex-1 sm:flex-none">
                  <label class="text-xs font-semibold text-slate-600" for="reportParaSelect">Paragraph</label>
                  <select id="reportParaSelect"
                    class="mt-1 w-full sm:w-40 rounded-xl border border-slate-200 bg-white px-3 py-3 text-base shadow-sm focus:outline-none focus:ring-4 focus:ring-slate-200">
                  </select>
                </div>

                <button id="clearReport"
                  class="inline-flex items-center justify-center rounded-xl bg-slate-900 px-4 py-3 text-base font-semibold text-white shadow-sm hover:bg-slate-800 active:scale-[0.99] focus:outline-none focus:ring-4 focus:ring-slate-200">
                  Clear Report
                </button>
              </div>
            </div>

            <div class="mt-4 grid gap-3 sm:grid-cols-5">
              <div class="sm:col-span-3 grid gap-3 sm:grid-cols-3">
                <div class="rounded-2xl bg-white p-4 shadow-sm ring-1 ring-slate-200">
                  <p class="text-xs font-semibold text-slate-600">Total words</p>
                  <p id="statTotalWords" class="mt-1 text-2xl font-bold">0</p>
                </div>
                <div class="rounded-2xl bg-white p-4 shadow-sm ring-1 ring-slate-200">
                  <p class="text-xs font-semibold text-slate-600">Correct words</p>
                  <p id="statCorrectWords" class="mt-1 text-2xl font-bold">0</p>
                </div>
                <div class="rounded-2xl bg-white p-4 shadow-sm ring-1 ring-slate-200">
                  <p class="text-xs font-semibold text-slate-600">Accuracy</p>
                  <p id="statAccuracy" class="mt-1 text-2xl font-bold">0%</p>
                </div>
              </div>

              <div class="sm:col-span-2 rounded-2xl bg-white p-4 shadow-sm ring-1 ring-slate-200">
                <div class="flex items-center justify-between">
                  <div>
                    <p class="text-xs font-semibold text-slate-600">Accuracy graph</p>
                    <p class="text-sm text-slate-600">Overall</p>
                  </div>
                  <span id="graphLabel" class="text-xs font-semibold text-slate-500">0%</span>
                </div>

                <div class="mt-3 flex items-center justify-center">
                  <svg width="140" height="140" viewBox="0 0 120 120" class="select-none">
                    <circle cx="60" cy="60" r="46" fill="none" stroke="#e2e8f0" stroke-width="12" />
                    <circle id="accuracyArc" cx="60" cy="60" r="46" fill="none" stroke="#10b981" stroke-width="12"
                      stroke-linecap="round" stroke-dasharray="0 999" transform="rotate(-90 60 60)" />
                    <text id="accuracyText" x="60" y="64" text-anchor="middle" font-size="22" font-weight="700" fill="#0f172a">0%</text>
                  </svg>
                </div>
              </div>
            </div>

            <div class="mt-4 rounded-2xl bg-white p-4 shadow-sm ring-1 ring-slate-200">
              <p class="text-sm font-bold">Selected paragraph preview</p>
              <p class="text-xs text-slate-600 mt-1">Use the dropdown above. (Evidence download is on the Read tab.)</p>

              <div class="mt-3 grid gap-3 sm:grid-cols-2">
                <div class="rounded-2xl bg-slate-50 p-4 ring-1 ring-slate-200">
                  <p class="text-xs font-semibold text-slate-600">Correct</p>
                  <div id="reportCorrectChips" class="mt-2 flex flex-wrap gap-2"></div>
                </div>
                <div class="rounded-2xl bg-slate-50 p-4 ring-1 ring-slate-200">
                  <p class="text-xs font-semibold text-slate-600">Not yet correct</p>
                  <div id="reportIncorrectChips" class="mt-2 flex flex-wrap gap-2"></div>
                </div>
              </div>
            </div>

            <p class="mt-4 text-xs text-slate-500">
              Tip: For short screenshots, go to a paragraph on “Read Along” and use “Download Paragraph Evidence”.
            </p>
          </div>
        </div>

      </div>
    </main>
  </div>

  <!-- Pronunciation Bubble (floating) -->
  <div id="pronounceBubble" class="hidden fixed z-50 max-w-[92vw] sm:max-w-sm">
    <div class="rounded-2xl bg-white shadow-lg ring-1 ring-slate-200 p-4">
      <div class="flex items-start justify-between gap-3">
        <div>
          <p class="text-xs font-semibold text-slate-500">Pronunciation practice</p>
          <p id="pbWord" class="mt-1 text-xl font-bold text-slate-900"></p>
          <p id="pbLang" class="mt-1 text-xs text-slate-500"></p>
        </div>
        <button id="pbClose" class="rounded-xl bg-slate-50 px-3 py-2 text-sm font-semibold text-slate-700 ring-1 ring-slate-200 hover:bg-slate-100">
          Close
        </button>
      </div>

      <div class="mt-3 grid grid-cols-2 sm:grid-cols-4 gap-2">
        <button id="pbPlay"
          class="inline-flex items-center justify-center rounded-xl bg-slate-900 px-3 py-3 text-sm font-semibold text-white shadow-sm hover:bg-slate-800 active:scale-[0.99] focus:outline-none focus:ring-4 focus:ring-slate-200">
          Play
        </button>
        <button id="pbSlow"
          class="inline-flex items-center justify-center rounded-xl bg-white px-3 py-3 text-sm font-semibold text-slate-900 shadow-sm ring-1 ring-slate-200 hover:bg-slate-50 active:scale-[0.99] focus:outline-none focus:ring-4 focus:ring-slate-200">
          Slow
        </button>
        <button id="pbRepeat"
          class="inline-flex items-center justify-center rounded-xl bg-white px-3 py-3 text-sm font-semibold text-slate-900 shadow-sm ring-1 ring-slate-200 hover:bg-slate-50 active:scale-[0.99] focus:outline-none focus:ring-4 focus:ring-slate-200">
          Repeat ×2
        </button>
        <button id="pbStop"
          class="inline-flex items-center justify-center rounded-xl bg-white px-3 py-3 text-sm font-semibold text-slate-900 shadow-sm ring-1 ring-slate-200 hover:bg-slate-50 active:scale-[0.99] focus:outline-none focus:ring-4 focus:ring-slate-200">
          Stop
        </button>
      </div>

      <p class="mt-3 text-xs text-slate-500">
        Tip: Say it after you hear it. Then try again with “Slow”.
      </p>
    </div>
  </div>

  <!-- html2canvas for DOM -> image capture (client-side only) -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<script>
(() => {
  // ---------------------------
  // Fixed Content
  // ---------------------------
  const CONTENT = {
    title: 'THE WANDERER',
    author: 'Sharon Creech',
    context: 'The main character, Sophie, is an orphan adopted by uncles. She is sailing across the Atlantic with her cousins.',
    paragraphs: [
      "I am not always such a dreamy girl, listening to the sea calling me. My father calls me Three-sided Sophie: one side is dreamy and romantic; one is logical and down-to-earth; and the third side is hardheaded and impulsive. He says I am either in dreamland or earthland or mule-land, and if I ever get the three together, I'll be all set, though I wonder where I will be then. If I'm not in dreamland or earthland or mule-land, where will I be?",
      "My father says my logical side is most like him, and the dreamy side most like my mother, which isn't entirely fair, I don't think. My father likes to think of himself as a logical man, but he is the one who pores over pictures of exotic lands and says things like \"We should go on a safari!\" and \"We should zip through the air in a hot-air balloon!\"",
      "And although my mother is a weaver and spins silky cloths and wears flowing dresses, she is the one who gives me sailing textbooks and makes me study water safety and weather prediction and says things like \"Yes, Sophie, I taught you to sail, but that doesn't mean I like the idea of you being out there alone on the water. I want you to stay home. Here. With me. Safe.\"",
      "My father says he doesn't know who my hardheaded mule side resembles. He says mules don't run in the family. I am thirteen, and I am going to sail across the ocean. Although I would like to go alone-alone! alone! flying over the water!-I'm not.",
      "My mule-self begged a place aboard a forty-five-foot sailboat with a motley crew: three uncles and two cousins. The uncles-Stew, Mo, and Dock-are my mother's brothers, and she told them, \"If the slightest harm comes to my Sophie, I'll string you all up by your toes.\""
    ]
  };

  // ---------------------------
  // DOM
  // ---------------------------
  const $ = (id) => document.getElementById(id);

  const titleEl = $('title');
  const contextEl = $('context');

  const paragraphDisplay = $('paragraphDisplay');
  const transcriptBox = $('transcriptBox');

  const studentNameInput = $('studentName');
  const nameError = $('nameError');
  const readStudent = $('readStudent');
  const reportStudent = $('reportStudent');

  const micBtn = $('micBtn');
  const prevBtn = $('prevBtn');
  const nextBtn = $('nextBtn');
  const restartBtn = $('restartBtn');
  const clearTranscriptBtn = $('clearTranscript');
  const langSelect = $('langSelect');

  const statusText = $('statusText');
  const statusDot = $('statusDot');
  const unsupported = $('unsupported');

  const paraIdxEl = $('paraIdx');
  const paraTotalEl = $('paraTotal');

  // Tabs
  const tabReadBtn = $('tabRead');
  const tabReportBtn = $('tabReport');
  const readTab = $('readTab');
  const reportTabPanel = $('reportTabPanel');

  // Read-tab paragraph report
  const paraStatTotal = $('paraStatTotal');
  const paraStatCorrect = $('paraStatCorrect');
  const paraStatAccuracy = $('paraStatAccuracy');
  const paraGraphLabel = $('paraGraphLabel');
  const paraAccuracyArc = $('paraAccuracyArc');
  const paraAccuracyText = $('paraAccuracyText');
  const paraCorrectChips = $('paraCorrectChips');
  const paraIncorrectChips = $('paraIncorrectChips');
  const readCapture = $('readCapture');
  const downloadParagraphBtn = $('downloadParagraph');
  const downloadParaFormat = $('downloadParaFormat');
  const downloadParaHint = $('downloadParaHint');

  // Report tab (short)
  const reportParaSelect = $('reportParaSelect');
  const clearReportBtn = $('clearReport');
  const statTotalWords = $('statTotalWords');
  const statCorrectWords = $('statCorrectWords');
  const statAccuracy = $('statAccuracy');
  const graphLabel = $('graphLabel');
  const accuracyArc = $('accuracyArc');
  const accuracyText = $('accuracyText');
  const reportCorrectChips = $('reportCorrectChips');
  const reportIncorrectChips = $('reportIncorrectChips');

  // Pronunciation bubble
  const pronounceBubble = $('pronounceBubble');
  const pbWord = $('pbWord');
  const pbLang = $('pbLang');
  const pbClose = $('pbClose');
  const pbPlay = $('pbPlay');
  const pbSlow = $('pbSlow');
  const pbRepeat = $('pbRepeat');
  const pbStop = $('pbStop');

  // ---------------------------
  // Web Speech Support
  // ---------------------------
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  const isSupported = !!SpeechRecognition;

  if (!isSupported) {
    unsupported.classList.remove('hidden');
    [
      studentNameInput, micBtn, prevBtn, nextBtn, restartBtn, langSelect, clearTranscriptBtn,
      tabReadBtn, tabReportBtn, clearReportBtn, downloadParagraphBtn, downloadParaFormat, reportParaSelect
    ].forEach(el => {
      el.disabled = true;
      el.classList.add('opacity-50', 'cursor-not-allowed');
    });
  }

  // ---------------------------
  // State
  // ---------------------------
  let studentName = '';
  let paragraphIndex = 0;
  let listening = false;

  let spanWords = [];

  // Pause/resume keeps progress:
  let accumulatedFinalText = '';
  let interimText = '';
  let finalMatchedCount = 0;
  let combinedMatchedCount = 0;

  let progress = [];
  let paragraphTokens = [];
  let recognition = null;

  // Speech synthesis
  let voices = [];
  let currentPronounceWord = '';

  // ---------------------------
  // Helpers
  // ---------------------------
  const normalizeWord = (w) => (w || '')
    .toLowerCase()
    .replace(/['’]/g, '')
    .replace(/[^a-z0-9]+/g, '')
    .trim();

  const cleanWordForPlayback = (w) => {
    const s = (w || '').trim();
    const stripped = s.replace(/^[^A-Za-z0-9']+|[^A-Za-z0-9']+$/g, '');
    return stripped || s;
  };

  const tokenize = (text) => (text || '')
    .replace(/\s+/g, ' ')
    .trim()
    .split(' ')
    .map(normalizeWord)
    .filter(Boolean);

  const computeMatchedCount = (heardTokens, targetTokens) => {
    let i = 0;
    for (const t of heardTokens) {
      if (i >= targetTokens.length) break;
      if (!t) continue;
      if (t === targetTokens[i]) i++;
    }
    return i;
  };

  const setStatus = (label, dotColor) => {
    statusText.textContent = label;
    statusDot.style.background = dotColor;
  };

  const setTranscript = (finalText, interim) => {
    const f = (finalText || '').trim();
    const it = (interim || '').trim();

    if (!f && !it) {
      transcriptBox.innerHTML = '<span class="text-slate-400">(interim results will appear here)</span>';
      return;
    }

    transcriptBox.innerHTML = '';
    if (f) {
      const fSpan = document.createElement('span');
      fSpan.textContent = f;
      transcriptBox.appendChild(fSpan);
    }
    if (it) {
      if (f) transcriptBox.appendChild(document.createTextNode(' '));
      const iSpan = document.createElement('span');
      iSpan.textContent = it;
      iSpan.className = 'italic text-slate-500';
      transcriptBox.appendChild(iSpan);
    }
  };

  const clearRecognitionBufferUI = () => {
    accumulatedFinalText = '';
    interimText = '';
    finalMatchedCount = 0;
    combinedMatchedCount = 0;
    setTranscript('', '');
    renderHighlights();
    renderParagraphReport(); // keep paragraph report synced
  };

  const buildTokensAndProgress = () => {
    paragraphTokens = CONTENT.paragraphs.map(p => {
      const raw = (p || '').replace(/\s+/g, ' ').trim().split(' ').filter(Boolean);
      return raw.map(tok => ({ original: tok, norm: normalizeWord(tok) })).filter(t => t.norm);
    });
    progress = CONTENT.paragraphs.map(() => ({ bestFinalCount: 0, bestCombinedCount: 0 }));
  };

  const setDonut = (arcEl, textEl, labelEl, accuracyPct) => {
    const pct = Math.max(0, Math.min(100, Math.round(accuracyPct)));
    const r = 46;
    const c = 2 * Math.PI * r;
    const dash = (pct / 100) * c;

    arcEl.setAttribute('stroke-dasharray', `${dash} ${Math.max(0, c - dash)}`);
    textEl.textContent = `${pct}%`;
    if (labelEl) labelEl.textContent = `${pct}%`;
  };

  const sanitizeFilenamePart = (s) => (s || 'student')
    .trim()
    .toLowerCase()
    .replace(/\s+/g, '_')
    .replace(/[^a-z0-9_\-]/g, '')
    .slice(0, 40) || 'student';

  const pad2 = (n) => String(n).padStart(2, '0');
  const makeTimestamp = () => {
    const d = new Date();
    return `${d.getFullYear()}${pad2(d.getMonth()+1)}${pad2(d.getDate())}-${pad2(d.getHours())}${pad2(d.getMinutes())}${pad2(d.getSeconds())}`;
  };

  // ---------------------------
  // Mandatory name logic
  // ---------------------------
  const validateName = () => {
    studentName = (studentNameInput.value || '').trim();
    const ok = studentName.length > 0;

    nameError.classList.toggle('hidden', ok);
    studentNameInput.classList.toggle('border-rose-300', !ok);
    studentNameInput.classList.toggle('ring-rose-200', !ok);

    if (isSupported) {
      micBtn.disabled = !ok;
      micBtn.classList.toggle('opacity-50', !ok);
      micBtn.classList.toggle('cursor-not-allowed', !ok);
      downloadParagraphBtn.disabled = !ok;
      downloadParagraphBtn.classList.toggle('opacity-50', !ok);
      downloadParagraphBtn.classList.toggle('cursor-not-allowed', !ok);
    }

    const label = ok ? studentName : '—';
    readStudent.textContent = label;
    reportStudent.textContent = label;

    return ok;
  };

  const requireNameOrFocus = () => {
    const ok = validateName();
    if (!ok) {
      setStatus('Please enter your name', '#ef4444');
      studentNameInput.focus();
      studentNameInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
    return ok;
  };

  // ---------------------------
  // Pronunciation Bubble (Speech Synthesis)
  // ---------------------------
  const loadVoices = () => {
    voices = window.speechSynthesis ? window.speechSynthesis.getVoices() : [];
  };

  const pickVoiceForLang = (lang) => {
    if (!voices || voices.length === 0) return null;
    const exact = voices.find(v => (v.lang || '').toLowerCase() === (lang || '').toLowerCase());
    if (exact) return exact;
    const prefix = voices.find(v => (v.lang || '').toLowerCase().startsWith((lang || '').toLowerCase().slice(0,2)));
    if (prefix) return prefix;
    const english = voices.find(v => (v.lang || '').toLowerCase().startsWith('en'));
    return english || null;
  };

  const speakWord = (word, rate = 1) => {
    if (!window.speechSynthesis) return;
    const w = cleanWordForPlayback(word);
    if (!w) return;

    window.speechSynthesis.cancel();

    const utter = new SpeechSynthesisUtterance(w);
    const lang = langSelect.value || 'en-US';
    utter.lang = lang;
    utter.rate = rate;

    const voice = pickVoiceForLang(lang);
    if (voice) utter.voice = voice;

    window.speechSynthesis.speak(utter);
  };

  const stopSpeech = () => {
    if (!window.speechSynthesis) return;
    window.speechSynthesis.cancel();
  };

  const positionBubbleNearElement = (el) => {
    const rect = el.getBoundingClientRect();
    const bubbleRect = pronounceBubble.getBoundingClientRect();

    const margin = 10;
    let top = rect.bottom + margin;
    let left = rect.left;

    const maxLeft = window.innerWidth - bubbleRect.width - margin;
    left = Math.max(margin, Math.min(left, maxLeft));

    if (top + bubbleRect.height + margin > window.innerHeight) {
      top = rect.top - bubbleRect.height - margin;
      if (top < margin) top = margin;
    }

    pronounceBubble.style.top = `${Math.round(top)}px`;
    pronounceBubble.style.left = `${Math.round(left)}px`;
  };

  const openPronounceBubble = (anchorEl, word) => {
    currentPronounceWord = cleanWordForPlayback(word);
    if (!currentPronounceWord) return;

    pbWord.textContent = currentPronounceWord;
    pbLang.textContent = `Voice: ${langSelect.value || 'en-US'} (uses your device/browser voices)`;

    pronounceBubble.classList.remove('hidden');

    requestAnimationFrame(() => {
      positionBubbleNearElement(anchorEl);
      speakWord(currentPronounceWord, 1);
    });
  };

  const closePronounceBubble = () => {
    pronounceBubble.classList.add('hidden');
    currentPronounceWord = '';
    stopSpeech();
  };

  const addDblClickAndLongPress = (el, getWordFn) => {
    let pressTimer = null;
    const LONG_PRESS_MS = 520;

    el.addEventListener('dblclick', (e) => {
      e.preventDefault();
      e.stopPropagation();
      openPronounceBubble(el, getWordFn());
    });

    el.addEventListener('pointerdown', () => {
      pressTimer = setTimeout(() => openPronounceBubble(el, getWordFn()), LONG_PRESS_MS);
    });

    const clear = () => {
      if (pressTimer) clearTimeout(pressTimer);
      pressTimer = null;
    };
    el.addEventListener('pointerup', clear);
    el.addEventListener('pointerleave', clear);
  };

  pbClose.addEventListener('click', closePronounceBubble);
  pbPlay.addEventListener('click', () => speakWord(currentPronounceWord, 1));
  pbSlow.addEventListener('click', () => speakWord(currentPronounceWord, 0.8));
  pbRepeat.addEventListener('click', () => {
    if (!currentPronounceWord) return;
    stopSpeech();
    speakWord(currentPronounceWord, 1);
    setTimeout(() => speakWord(currentPronounceWord, 1), 850);
  });
  pbStop.addEventListener('click', stopSpeech);

  document.addEventListener('click', (e) => {
    if (pronounceBubble.classList.contains('hidden')) return;
    if (pronounceBubble.contains(e.target)) return;
    closePronounceBubble();
  });

  window.addEventListener('scroll', () => {
    if (!pronounceBubble.classList.contains('hidden')) closePronounceBubble();
  }, { passive: true });

  // ---------------------------
  // Tabs
  // ---------------------------
  const setActiveTab = (tab) => {
    const isRead = tab === 'read';
    readTab.classList.toggle('hidden', !isRead);
    reportTabPanel.classList.toggle('hidden', isRead);

    const active = 'bg-slate-900 text-white ring-slate-900';
    const inactive = 'bg-white text-slate-900 ring-slate-200 hover:bg-slate-50';

    tabReadBtn.className = `flex-1 sm:flex-none inline-flex items-center justify-center rounded-xl px-4 py-3 text-base font-semibold shadow-sm ring-1 focus:outline-none focus:ring-4 focus:ring-slate-200 ${isRead ? active : inactive}`;
    tabReportBtn.className = `flex-1 sm:flex-none inline-flex items-center justify-center rounded-xl px-4 py-3 text-base font-semibold shadow-sm ring-1 focus:outline-none focus:ring-4 focus:ring-slate-200 ${!isRead ? active : inactive}`;

    if (!isRead) {
      renderOverallReport();
      renderReportTabParagraph(reportParaSelect.value ? Number(reportParaSelect.value) : paragraphIndex);
    }
  };

  // ---------------------------
  // Rendering
  // ---------------------------
  const escapeHtml = (s) => (s || '').replace(/[&<>"']/g, (c) => ({
    '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
  }[c]));

  const renderHeader = () => {
    titleEl.innerHTML = `${escapeHtml(CONTENT.title)} <span class="text-slate-500 font-semibold">by ${escapeHtml(CONTENT.author || '')}</span>`;
    contextEl.textContent = CONTENT.context || '';
    paraTotalEl.textContent = String(CONTENT.paragraphs.length);
  };

  const renderParagraph = () => {
    const paragraph = CONTENT.paragraphs[paragraphIndex] || '';
    const rawTokens = paragraph.replace(/\s+/g, ' ').trim().split(' ').filter(Boolean);

    spanWords = rawTokens.map((tok) => {
      const span = document.createElement('span');
      span.textContent = tok;
      span.className = 'transition-colors duration-200 cursor-pointer select-none';
      addDblClickAndLongPress(span, () => tok);
      return { original: tok, norm: normalizeWord(tok), el: span };
    });

    paragraphDisplay.innerHTML = '';
    spanWords.forEach((w, idx) => {
      paragraphDisplay.appendChild(w.el);
      if (idx < spanWords.length - 1) paragraphDisplay.appendChild(document.createTextNode(' '));
    });

    paraIdxEl.textContent = String(paragraphIndex + 1);

    // By spec: on paragraph change, reset buffer
    clearRecognitionBufferUI();

    prevBtn.disabled = paragraphIndex === 0;
    nextBtn.disabled = paragraphIndex === CONTENT.paragraphs.length - 1;
    [prevBtn, nextBtn].forEach(btn => {
      btn.classList.toggle('opacity-50', btn.disabled);
      btn.classList.toggle('cursor-not-allowed', btn.disabled);
    });

    // Keep report dropdown in sync
    if (reportParaSelect.options.length) reportParaSelect.value = String(paragraphIndex);

    renderParagraphReport();
  };

  const renderHighlights = () => {
    const targetTokens = spanWords.map(w => w.norm).filter(Boolean);
    const finalCount = Math.min(finalMatchedCount, targetTokens.length);
    const combinedCount = Math.min(combinedMatchedCount, targetTokens.length);

    let normalizedIndex = 0;
    for (const w of spanWords) {
      if (!w.norm) {
        w.el.className = 'transition-colors duration-200 text-slate-900 cursor-pointer select-none';
        continue;
      }

      const idx = normalizedIndex;

      if (idx < finalCount) {
        w.el.className = 'transition-colors duration-200 font-semibold text-emerald-700 cursor-pointer select-none';
      } else if (idx < combinedCount) {
        w.el.className = 'transition-colors duration-200 font-semibold text-emerald-500 cursor-pointer select-none';
      } else if (idx === combinedCount) {
        w.el.className = 'transition-colors duration-200 text-slate-900 underline decoration-amber-400 decoration-4 underline-offset-4 cursor-pointer select-none';
      } else {
        w.el.className = 'transition-colors duration-200 text-slate-900 cursor-pointer select-none';
      }

      normalizedIndex++;
    }
  };

  const makeChip = (tokenObj, type) => {
    const chip = document.createElement('span');
    chip.className =
      type === 'correct'
        ? 'rounded-full bg-emerald-50 px-3 py-1 text-sm font-semibold text-emerald-700 ring-1 ring-emerald-200 cursor-pointer select-none'
        : 'rounded-full bg-rose-50 px-3 py-1 text-sm font-semibold text-rose-700 ring-1 ring-rose-200 cursor-pointer select-none';
    chip.textContent = tokenObj.original;
    addDblClickAndLongPress(chip, () => tokenObj.original);
    return chip;
  };

  const renderParagraphReport = () => {
    const tokens = paragraphTokens[paragraphIndex] || [];
    const best = Math.min(progress[paragraphIndex]?.bestFinalCount || 0, tokens.length);
    const pct = tokens.length ? Math.round((best / tokens.length) * 100) : 0;

    paraStatTotal.textContent = String(tokens.length);
    paraStatCorrect.textContent = String(best);
    paraStatAccuracy.textContent = `${pct}%`;
    setDonut(paraAccuracyArc, paraAccuracyText, paraGraphLabel, pct);

    paraCorrectChips.innerHTML = '';
    paraIncorrectChips.innerHTML = '';

    const correctTokens = tokens.slice(0, best);
    const incorrectTokens = tokens.slice(best);

    if (correctTokens.length === 0) {
      const empty = document.createElement('span');
      empty.className = 'text-sm text-slate-400';
      empty.textContent = '(none yet)';
      paraCorrectChips.appendChild(empty);
    } else {
      correctTokens.forEach(t => paraCorrectChips.appendChild(makeChip(t, 'correct')));
    }

    if (incorrectTokens.length === 0) {
      const empty = document.createElement('span');
      empty.className = 'text-sm text-slate-400';
      empty.textContent = '(all words correct!)';
      paraIncorrectChips.appendChild(empty);
    } else {
      incorrectTokens.forEach(t => paraIncorrectChips.appendChild(makeChip(t, 'incorrect')));
    }
  };

  const renderOverallReport = () => {
    validateName();

    const totalWords = paragraphTokens.reduce((sum, arr) => sum + arr.length, 0);
    const correctWords = paragraphTokens.reduce(
      (sum, arr, i) => sum + Math.min(progress[i]?.bestFinalCount || 0, arr.length),
      0
    );
    const accuracy = totalWords === 0 ? 0 : Math.round((correctWords / totalWords) * 100);

    statTotalWords.textContent = String(totalWords);
    statCorrectWords.textContent = String(correctWords);
    statAccuracy.textContent = `${accuracy}%`;
    setDonut(accuracyArc, accuracyText, graphLabel, accuracy);
  };

  const renderReportTabParagraph = (idx) => {
    const i = Math.max(0, Math.min(idx, CONTENT.paragraphs.length - 1));
    const tokens = paragraphTokens[i] || [];
    const best = Math.min(progress[i]?.bestFinalCount || 0, tokens.length);

    reportCorrectChips.innerHTML = '';
    reportIncorrectChips.innerHTML = '';

    const correctTokens = tokens.slice(0, best);
    const incorrectTokens = tokens.slice(best);

    if (correctTokens.length === 0) {
      const empty = document.createElement('span');
      empty.className = 'text-sm text-slate-400';
      empty.textContent = '(none yet)';
      reportCorrectChips.appendChild(empty);
    } else {
      correctTokens.forEach(t => reportCorrectChips.appendChild(makeChip(t, 'correct')));
    }

    if (incorrectTokens.length === 0) {
      const empty = document.createElement('span');
      empty.className = 'text-sm text-slate-400';
      empty.textContent = '(all words correct!)';
      reportIncorrectChips.appendChild(empty);
    } else {
      incorrectTokens.forEach(t => reportIncorrectChips.appendChild(makeChip(t, 'incorrect')));
    }
  };

  // ---------------------------
  // Recognition lifecycle
  // ---------------------------
  const initRecognition = () => {
    if (!isSupported) return;

    recognition = new SpeechRecognition();
    recognition.lang = langSelect.value || 'en-US';
    recognition.continuous = true;
    recognition.interimResults = true;
    recognition.maxAlternatives = 1;

    recognition.onstart = () => {
      listening = true;
      micBtn.textContent = 'Stop';
      setStatus('Listening...', '#10b981');
    };

    recognition.onend = () => {
      listening = false;
      micBtn.textContent = 'Start Reading';
      setStatus('Paused', '#94a3b8');
      // no buffer reset here (true pause)
    };

    recognition.onerror = (e) => {
      if (e.error === 'not-allowed' || e.error === 'service-not-allowed') {
        setStatus('Microphone access denied', '#ef4444');
      } else if (e.error === 'no-speech') {
        setStatus('No speech detected', '#f59e0b');
      } else {
        setStatus(`Error: ${e.error}`, '#ef4444');
      }
    };

    recognition.onresult = (event) => {
      let newInterim = '';

      // Accumulate only NEW final pieces using event.resultIndex
      for (let i = event.resultIndex; i < event.results.length; i++) {
        const res = event.results[i];
        const text = res[0].transcript;
        if (res.isFinal) accumulatedFinalText += (text + ' ');
        else newInterim += (text + ' ');
      }

      accumulatedFinalText = accumulatedFinalText.replace(/\s+/g, ' ').trim();
      interimText = newInterim.replace(/\s+/g, ' ').trim();

      setTranscript(accumulatedFinalText, interimText);

      const targetTokens = spanWords.map(w => w.norm).filter(Boolean);
      finalMatchedCount = computeMatchedCount(tokenize(accumulatedFinalText), targetTokens);
      combinedMatchedCount = computeMatchedCount(tokenize((accumulatedFinalText + ' ' + interimText).trim()), targetTokens);

      const tLen = paragraphTokens[paragraphIndex]?.length || targetTokens.length;
      const cur = progress[paragraphIndex];
      if (cur) {
        cur.bestFinalCount = Math.min(Math.max(cur.bestFinalCount, finalMatchedCount), tLen);
        cur.bestCombinedCount = Math.min(Math.max(cur.bestCombinedCount, combinedMatchedCount), tLen);
      }

      renderHighlights();
      renderParagraphReport();

      if (!reportTabPanel.classList.contains('hidden')) {
        renderOverallReport();
        renderReportTabParagraph(reportParaSelect.value ? Number(reportParaSelect.value) : paragraphIndex);
      }
    };
  };

  const startListening = () => {
    if (!isSupported) return;
    if (!recognition) initRecognition();
    try { recognition.start(); } catch (_) {}
  };

  const stopListening = () => {
    if (!isSupported || !recognition) return;
    try { recognition.stop(); } catch (_) {}
  };

  const hardResetRecognition = (keepListening) => {
    if (!isSupported) return;
    const shouldResume = !!keepListening;

    try { recognition && recognition.abort(); } catch (_) {}
    recognition = null;
    initRecognition();

    // Used only when we WANT to clear: paragraph change/restart/clear transcript
    clearRecognitionBufferUI();

    if (shouldResume) setTimeout(() => startListening(), 120);
  };

  // ---------------------------
  // Navigation
  // ---------------------------
  const goToParagraph = (idx) => {
    const clamped = Math.max(0, Math.min(idx, CONTENT.paragraphs.length - 1));
    if (clamped === paragraphIndex) return;

    const wasListening = listening;
    if (wasListening) stopListening();

    paragraphIndex = clamped;
    renderParagraph();

    hardResetRecognition(wasListening);
  };

  const restartParagraph = () => {
    const wasListening = listening;
    if (wasListening) stopListening();
    hardResetRecognition(wasListening);
  };

  // ---------------------------
  // Download short evidence (current paragraph only)
  // ---------------------------
  const downloadDataUrl = (dataUrl, filename) => {
    const a = document.createElement('a');
    a.href = dataUrl;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
  };

  const captureCurrentParagraphEvidence = async () => {
    if (!requireNameOrFocus()) return;

    // Ensure report reflects latest state
    renderParagraphReport();

    const format = (downloadParaFormat.value || 'png').toLowerCase();
    const isJpg = format === 'jpg' || format === 'jpeg';

    try {
      downloadParaHint.textContent = 'Creating image…';

      const canvas = await html2canvas(readCapture, {
        backgroundColor: '#ffffff',
        scale: 2,
        useCORS: true
      });

      const who = sanitizeFilenamePart(studentName);
      const stamp = makeTimestamp();
      const p = `p${paragraphIndex + 1}`;

      if (isJpg) {
        const dataUrl = canvas.toDataURL('image/jpeg', 0.92);
        downloadDataUrl(dataUrl, `read-along_${who}_${p}_${stamp}.jpg`);
      } else {
        const dataUrl = canvas.toDataURL('image/png');
        downloadDataUrl(dataUrl, `read-along_${who}_${p}_${stamp}.png`);
      }

      downloadParaHint.textContent = 'Downloaded.';
      setTimeout(() => (downloadParaHint.textContent = ''), 2000);
    } catch (err) {
      console.error(err);
      downloadParaHint.textContent = 'Could not create image (try Chrome/Edge).';
      setTimeout(() => (downloadParaHint.textContent = ''), 4000);
    }
  };

  // ---------------------------
  // Events
  // ---------------------------
  studentNameInput.addEventListener('input', () => {
    validateName();
    if (studentNameInput.value.trim().length > 0) setStatus('Paused', '#94a3b8');
  });
  studentNameInput.addEventListener('blur', validateName);

  micBtn.addEventListener('click', () => {
    if (!isSupported) return;
    if (!requireNameOrFocus()) return;
    if (!recognition) initRecognition();

    if (!listening) {
      // Resume without resetting
      startListening();
    } else {
      // Pause (no reset)
      stopListening();
    }
  });

  prevBtn.addEventListener('click', () => goToParagraph(paragraphIndex - 1));
  nextBtn.addEventListener('click', () => goToParagraph(paragraphIndex + 1));
  restartBtn.addEventListener('click', restartParagraph);

  clearTranscriptBtn.addEventListener('click', () => {
    const wasListening = listening;
    if (wasListening) stopListening();

    // Explicit clear: wipe buffers, keep paragraph
    clearRecognitionBufferUI();

    // Re-init engine, resume if needed
    try { recognition && recognition.abort(); } catch (_) {}
    recognition = null;
    initRecognition();
    if (wasListening) setTimeout(() => startListening(), 120);
  });

  langSelect.addEventListener('change', () => {
    loadVoices();

    const wasListening = listening;
    if (wasListening) stopListening();

    // Change language WITHOUT wiping progress
    try { recognition && recognition.abort(); } catch (_) {}
    recognition = null;
    initRecognition();

    setTranscript(accumulatedFinalText, interimText);
    renderHighlights();
    renderParagraphReport();

    if (wasListening) setTimeout(() => startListening(), 120);

    if (!pronounceBubble.classList.contains('hidden') && currentPronounceWord) {
      pbLang.textContent = `Voice: ${langSelect.value || 'en-US'} (uses your device/browser voices)`;
    }
  });

  tabReadBtn.addEventListener('click', () => setActiveTab('read'));
  tabReportBtn.addEventListener('click', () => setActiveTab('report'));

  reportParaSelect.addEventListener('change', () => {
    const idx = Number(reportParaSelect.value);
    renderReportTabParagraph(idx);
  });

  clearReportBtn.addEventListener('click', ()
